% filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};

% filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};

% filename = {'M090SC100a_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100i_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100a_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100i_no_hade'};

filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade'};

filename = {'M090SC90j_no_hade_load_coef','M090SC90i_no_hade_load_coef','M090SC90a_no_hade_load_coef','M090SC90e_no_hade_load_coef','M090SC90g_no_hade_load_coef','M090SC90d_no_hade_load_coef','M090SC90h_no_hade_load_coef'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = filename;

% filename = {'M090SC100g_no_hade'};
% outnames = {'_SA_4_0'};
% rjm_directory = {'M090SC100g_no_hade'};

%% Mt=0.79; M=0.90; changing s/c;
% shorter list
% filename = {'RMCA0669a2','M09SC110','M09SC100c','M090SC090','M090SC080','M090SC070'};
% outnames = {'C5_SA_4','_SA_4_0','S4_SA_4','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'RMCA0669a2','M09SC110','M09SC100c','M090SC090','M090SC080','M090SC070'};

% filename = {'M090SC70_s_c_no_hade','M090SC80_s_c_no_hade','M090SC90_s_c_no_hade','M090SC100_s_c_no_hade','M090SC110_s_c_no_hade','M090SC120_s_c_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC70_s_c_no_hade','M090SC80_s_c_no_hade','M090SC90_s_c_no_hade','M090SC100_s_c_no_hade','M090SC110_s_c_no_hade','M090SC120_s_c_no_hade'};
%
% %% M090SC100_thickness 2%
% filename = {'M090SC100j_no_hade_load_coef_2%','M090SC100i_no_hade_load_coef_2%','M090SC100a_no_hade_load_coef_2%','M090SC100e_no_hade_load_coef_2%','M090SC100g_no_hade_load_coef_2%','M090SC100d_no_hade_load_coef_2%','M090SC100h_no_hade_load_coef_2%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% rjm_directory = filename;
%
% %% M090SC100 thickness 3%
% filename = {'M090SC100j_no_hade_load_coef_3%','M090SC100i_no_hade_load_coef_3%','M090SC100a_no_hade_load_coef_3%','M090SC100e_no_hade_load_coef_3%','M090SC100g_no_hade_load_coef_3%','M090SC100d_no_hade_load_coef_3%','M090SC100h_no_hade_load_coef_3%','M090SC100j_no_hade3_3%','M090SC100j_no_hade4_3%','M090SC100g_no_hade2_3%','M090SC100g_no_hade3_3%','M090SC100l_no_hade_3%','M090SC100m_no_hade_3%','M090SC100n_no_hade_3%','M090SC100p_no_hade_3%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% rjm_directory = filename;
% %%
%
% %% M090SC100 A98%
% filename = {'M090SC100j_no_hade_load_coef_A98%','M090SC100i_no_hade_load_coef_A98%','M090SC100a_no_hade_load_coef_A98%','M090SC100e_no_hade_load_coef_A98%','M090SC100g_no_hade_load_coef_A98%','M090SC100d_no_hade_load_coef_A98%','M090SC100h_no_hade_load_coef_A98%','M090SC100j_no_hade3_A98%','M090SC100j_no_hade4_A98%','M090SC100g_no_hade2_A98%','M090SC100g_no_hade3_A98%','M090SC100l_no_hade_A98%','M090SC100m_no_hade_A98%','M090SC100n_no_hade_A98%','M090SC100p_no_hade_A98%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = filename;

filename = {'M090SC100d_no_hade'};
outnames = {'_SA_4_0'};
rjm_directory = filename;

%% M090SC080
% filename = {'M090SC80j_no_hade_load_coef','M090SC80i_no_hade_load_coef','M090SC80a_no_hade_load_coef','M090SC80e_no_hade_load_coef','M090SC80g_no_hade_load_coef','M090SC80d_no_hade_load_coef','M090SC80h_no_hade_load_coef','M090SC80j_no_hade3','M090SC80j_no_hade4','M090SC80g_no_hade2','M090SC80g_no_hade3','M090SC80l_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% % filename = [ filename {'M090SC80_70_no_hade','M090SC80_80_no_hade','M090SC80_90_no_hade','M090SC80_80_no_hade','M090SC80_110_no_hade'}];
% rjm_directory = filename;
%%
%% inlet Mach = 0.65;
filename = {'M065SC75j_no_hade','M065SC75i_no_hade','M065SC75a_no_hade','M065SC75e_no_hade','M065SC75g_no_hade'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};

%% inlet Mach = 1.10
filename = {'M110SC90j_no_hade','M110SC90i_no_hade','M110SC90l_no_hade','M110SC90m_no_hade','M110SC90n_no_hade'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110SC90j_no_hade','M110SC90i_no_hade','M110SC90l_no_hade','M110SC90m_no_hade','M110SC90n_no_hade'};

filename = {'M110bSC90j_no_hade','M110bSC90i_no_hade','M110bSC90l_no_hade','M110bSC90m_no_hade','M110bSC90n_no_hade'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110bSC90j_no_hade','M110bSC90i_no_hade','M110bSC90l_no_hade','M110bSC90m_no_hade','M110bSC90n_no_hade'};

M = 1.1;
% Ax = 1;

s_c = 0.90;

%% ********Everything above shoud not be necessary (kept for history)********

%% figure linestyle and color details details

color = [0,0,1;1,0,0;0,0.5,0;1,0,1;0.5,0,0.5;0.5,0.5,0.5;0,0,0;0.25,0.25,0.25;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0];
Linestyle = {'-','--',':','-.','-','-','-','-','-','-'};

clear sweep chi_le_guess job


%% set thickness details used as datum

% choose blade you want to derive thickness from
blade_name = 'XWB84k_IPC_R1';
blade_name = 'TEN_I02R';
load(['/mnt/Disk1/dl467/Documents/Blades_parameterised/' blade_name '.mat']);
% choose non-dimensional section you want to take thickness from
r_nondim = 0.80;
thick_names = {'rad_le','s_thick_max','rad_thick_max','wedge_te','thick_te','thick_max','tchord'};
cam_names = {'chi_le','chi_te','perc_cam','pitch_chord','knot_coef','qcam','dcam_le','dcam_te'};
cam_spline = 1;
c = bl_spline_eval(t,r_nondim,cam_spline);
for v = 1:length(thick_names)
    job.(thick_names{v}) = c.(thick_names{v});
end
for v = 1:length(cam_names)
    job.(cam_names{v}) = c.(cam_names{v});
end
% just used if you want to check datum blade section used for thickness
dev=[]; ote = 1; plot_stuff = 0; cam_spline = 1;
%% USER defined job.knot_coef
job.knot_coef = [1.0000    1.0000    1.0000    1.0000    1.0000    0.8000    0.5000    1.0000];
%%
[xrt,xrt_cam,xrt_ps,xrt_ss]=bl_construct_section(job,plot_stuff,ote,dev,cam_spline);

%% set datum radius and chord for mises (just used for reference)

job.r_mid = 0.2677;
job.r_le = 0.2677;
job.r_te = 0.2677;

job.tchord = 0.05;

% air properties
ga = 1.4;
R = 287;

%% set datum design and one variable for sweeping

t_c_dat = 4/100;
s_c_dat = 0.80;
N_dat = round((2*pi*job.r_mid./job.tchord)./s_c_dat);

alpha_rel_inlet_dat = 60;
alpha_inlet_dat = 0;
M_inlet_dat = 0.90;
np = 0.95;
load_coef_dat = 0.40;

Ax_dat = 0.95;
% Axt_dat = 1.0;
dH_dat = 0.66;
mode = 2; % mode 1: constant psi & dh; mode 2: contant psi & Area ratio; mode 3: constnat dH and Area ratio ; mode 4: constant dH and throat area ratio
job.mode = mode;


%% define sweep variables
sweep.t_c = [4 3 5]/100;
sweep.Axt = [0.975 1.025 1.0 0.95];
sweep.s_c = [0.60 0.70 0.80 0.90 1.0];

% sweep.alpha_rel_inlet = [50 55 60 65];
% sweep.Ax = [1.0 0.95 0.975 0.90];
% sweep.load_coef = [0.40 0.35 0.30 0.45];

% extract variable that will be swept
var = fieldnames(sweep);

%% set local incidence target
psi_target = 0;


disp(['*** sweeping: '])
var

%%
for k = 1:length(var)
    
    disp(['*** sweeping: ' var{k} ' ****'])
    % remove before each sweep
    if isfield(job,'Axt') == 1
        job=rmfield(job,'Axt');
    end
    
    for m = 1:length(sweep.(var{k}))
        
        disp(['*** sweeping: ' var{k} ' ****'])
        
        job.psi_target = psi_target;
        
        % sweep through different perecentage cambers
        %     perc_cam = [0.10 0.05 0.001 -0.05 -0.1 -0.15 -0.20 -0.25 -0.30 -0.40];
        perc_cam = [0.60 0.50 0.40 0.30 0.20 0.10 0.05 0.0001 -0.10 -0.20];
        clear init chi_le_guess % clear inital solution once sweeping through key variable
        for i = 1:length(perc_cam)
            
            job.psi_target = psi_target;
            
            if isfield(job,'Axt') == 1
                job=rmfield(job,'Axt');
            end
            job.perc_cam = perc_cam(i);
            clear tot_cam local_inc H_TE loss dalpha_sort i_sort chi_le
            tot_cam = [];
            
            if strcmp(var{k},'s_c')==1
                s_c = sweep.s_c(m);
                job.N = round((2*pi*0.5*(job.r_le +job.r_te)./job.tchord)./s_c);
            else
                s_c = s_c_dat;
                job.N = N_dat;
            end
            
            if strcmp(var{k},'t_c')==1
                job.thick_max = sweep.t_c(m).*job.tchord;
                t_c = sweep.t_c(m);
            else
                job.thick_max = t_c_dat.*job.tchord;
                t_c = t_c_dat;
            end
            
            %% change inlet flow angle (or U/cpTo1) and Mach number
            if strcmp(var{k},'alpha_rel_inlet')==1
                job.alpha_rel_inlet = sweep.alpha_rel_inlet(m);
                if exist('chi_le_guess','var')==0 || isempty(chi_le_guess)==0
                    % initial guess
                    job.chi_le = sweep.alpha_rel_inlet(m)-2.0;
                else % use previous solution as a better initial guess
                    job.chi_le = chi_le_guess;
                    disp(['Guess for inlet cam ' num2str(chi_le_guess)])
                end
            else
                job.alpha_rel_inlet = alpha_rel_inlet_dat;
                
                if exist('chi_le_guess','var')==0 || isempty(chi_le_guess)==0
                    % initial guess
                    job.chi_le = job.alpha_rel_inlet-2.0;
                else % use previous solution as a better initial guess
                    job.chi_le = chi_le_guess;
                    disp(['Guess for inlet cam ' num2str(chi_le_guess)])
                end
            end
            
            if strcmp(var{k},'alpha_inlet')==1
                job.alpha_inlet = sweep.alpha_inlet(m);
            else
                job.alpha_inlet = alpha_inlet_dat;
            end
            
            if strcmp(var{k},'M_inlet')==1
                job.Mrel_inlet = sweep.M_inlet(m);
            else
                job.Mrel_inlet = M_inlet_dat;
            end
            
            %% set polytropic efficiency
            job.np = np;
            
            %% change aeroparameters
            if strcmp(var{k},'load_coef')==1
                job.load_coef = sweep.load_coef(m);
            else
                job.load_coef = load_coef_dat;
            end
            if strcmp(var{k},'dH')==1
                job.DeHaller = sweep.dH(m);
            else
                job.DeHaller = dH_dat;
            end
            
            %% change streamtube contraction
            if strcmp(var{k},'Ax')==1
                job.f.Ax = sweep.Ax(m);
            else
                job.f.Ax = Ax_dat;
            end
            
            
            %% change streamtube contraction
            if strcmp(var{k},'Axt')==1
                job.Axt = sweep.Axt(m);
                %         else
                %             job.Axt = Axt;
            end
            
            %% calculate exit Mach number and flow angle
            [f]=mises_output_finput(job,mode);
            job.f = f;
            job.f.M = job.Mrel_inlet;
            
            
            %% set target exit flow angle and chi_te initial value and change in dchi_te
            % set exit airflow angle
            alpha_tar = job.f.Alpha2;
            % first guess for exit flow blade metal angle
            if exist('init','var')==0
                job.init = 0;
            else
                job.init = init;
            end
            job.chi_te = job.f.Alpha2 + job.init;
            disp(['***** Initial solution init = ' num2str(job.init) ' degrees ******'])
            job.dinit = -0.50;
            
            %% Name new directory
            if mode  == 1
                ext = ['_psi0' num2str(100*job.load_coef) 'DH0'  num2str(100*job.DeHaller)];
            elseif mode  == 2
                if isfield(job,'Axt') == 0
                    ext = ['_psi0' num2str(100*job.load_coef) 'A' num2str(round(100*job.f.Ax))];
                else
                    ext = ['_psi0' num2str(100*job.load_coef) 'Axt' num2str(round(100*job.Axt)) 'A' num2str(round(100*job.f.Ax))];
                end
            elseif mode == 3
                ext = ['_DH0' num2str(100*job.DeHaller) 'A' num2str(round(100*job.f.Ax))];
            elseif mode == 4
                ext = ['_DH0' num2str(100*job.DeHaller) 'A' num2str(round(100*job.f.Ax))];
            end
            directory = ['/mnt/Disk1/dl467/Documents/Test_Cases/MISES_solutions/M' num2str(round(100*job.Mrel_inlet)) 'A' num2str(round(100*job.alpha_rel_inlet)/100) 'SC' num2str(round(100*s_c)) 'TC' num2str(round(100*t_c)) 'PC' num2str(round(100*job.perc_cam)) ext '/MISES/'];
            
            job.directory = directory;
            job.rjm_directory = directory;
            mis_directory = strrep(directory,'TURBOSTREAM','MISES');
            
            % Make directory if required
            if exist(directory,'dir') == 0
                mkdir(directory);
                disp([directory ': does not exist'])
                start = 1;
            else
                [p,h] = mis_plot_section(directory,[],[0,0,1],0,job);
                if isempty(p) == 0
                    load([directory 'job.mat']);
                    disp([directory ': solution already exists'])
                    start = 0;
                    [Polarx, Ises] = mis_read_polarx('mises',directory);
                    if size(Polarx.sout,2) == 1
                        [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                        P_ratio = Polarx.p2pt./Polarx.p1pt;
                    else
                        [~,i_des] = min(abs(Polarx.binl-(Ises.binl)));
                        Polarx.sout = Polarx.sout(i_des);
                    end
                    delta_alpha = atand( Polarx.sout ) - alpha_tar;
                    init = job.chi_te - job.f.Alpha2 + 1; % store to be used as first guess
                    chi_le_guess = job.chi_le;
                    if abs(delta_alpha) > 0.5
                        disp(['****** Run again difference between target and true exit flow angle: ' num2str(delta_alpha) ' degrees *****'])
                        start = 0;
                    end
                else
                    if exist([directory 'job_init.mat']) ~= 0
                        load([directory 'job_init.mat']);
                        if job.initial_sol == 0
                            start = 0; % initial solution has run and not converged skip
                            disp([directory ': initial solution failed to converge'])
                            if exist('init','var')==0
                                job.init = 0;
                            else % use previous successful iteration
                                job.init = init;
                                job.dinit = -0.25;
                                job.chi_le = chi_le_guess;
                            end
                            job.chi_te = job.f.Alpha2 + job.init;
                            disp(['***** Initial solution init = ' num2str(job.init) ' degrees ******'])
                        else
                            load([directory 'job.mat']);
                            if isfield(job,'conv')==1
                                if job.conv == 0
                                    start = 0; % initial solution has run and not converged skip
                                    disp([directory ': Final solution did not converge'])
                                elseif job.conv == -1
                                    start = 0; % initial solution has run and not converged within iteration number limit
                                    disp([directory ': Final solution not found within iteration number limit'])
                                elseif job.conv == 1 && isfield(job,'rerun')==0
                                    start = 0; % initial solution has converged but not within polar
                                    disp([directory ': Final solution has converged but not within polar run again'])
                                    [q,h,job] = mis_run_section(directory,[],[0,0,1],0,1,0,job);
                                    job.rerun = 1;
                                end
                            else
                                start = 1;
                                disp([directory ': Solution produced an unexpected error; diagnose and run again'])
                            end
                        end
                    else
                        start = 1;
                        disp([directory ': Initial solution does not exist: Run initial solution'])
                    end
                end
            end
            
            if start == 1
                
                %% run until you have correct guess for total camber sweep
                % ADJUST FRACTION chord to covered passage for initial guess
                if i == 1
                    [job]=ts_frac_chord_mises(job,[],2); % mode 1 - between shock and covered passage
                end
                q=[];
                q.manual = 1;
                n_initial = 1;
                n_initial_max = 10;
                job.initial_sol = 1;
                job.chi_le_init = job.chi_le;
                while q.manual == 1 && n_initial < n_initial_max
                    [q,h,job] = mis_run_section(directory,[],[0,0,1],0,1,1,job);
                    if q.manual == 1
                        disp(['******Cannot run at this total camber ' num2str(job.chi_le-job.chi_te) ' ******'])
                        job.chi_le = job.chi_le_init; % reset chi-le in case it has gone rogue
                    end
                    job.chi_te = job.chi_te + job.dinit;
                    n_initial = n_initial + 1;
                end
                if n_initial >= n_initial_max
                    disp('***** Cannot run initial solution try again*****')
                    job.initial_sol=0;
                    save([directory 'job_init.mat'],'job')
                    continue
                end
                
                save([directory 'job_init.mat'],'job')
                save([directory 'job.mat'],'job')
                
                %% start design iterations if initial solution was found
                
                % iteration number
                ni = 1;
                n_max = 10;
                job.n_max = n_max;
                beta=0.5;
                
                [Polarx, Ises] = mis_read_polarx('mises',directory);
                if size(Polarx.sout,2) == 1
                    [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                    P_ratio = Polarx.p2pt./Polarx.p1pt;
                else
                    [~,i_des] = min(abs(Polarx.binl-(Ises.binl)));
                    Polarx.sout = Polarx.sout(i_des);
                end
                
                
                while abs( atand(Polarx.sout) - alpha_tar)>0.25 && ni<n_max
                    disp(['*****Iteration number ' num2str(ni)  '****']);
                    save([directory 'job_temp.mat'],'job');
                    delta_alpha = atand( Polarx.sout ) - alpha_tar;
                    disp(['****** Difference between target and true exit flow angle: ' num2str(delta_alpha) ' degrees *****'])
                    %             if H_TE<3
                    % calculate change to be applied
                    if ni ~=1
                        dchi_te = (job.chi_te-job.chi_te_temp)/(delta_alpha-delta_alpha_temp)*(delta_alpha)
                    else
                        dchi_te = beta*delta_alpha
                    end
                    % in case delta_alpha = delta_alpha_temp and dchi_te = NaN
                    if isnan(dchi_te)==1
                        dchi_te = beta*delta_alpha
                    end
                    % store previous values to calcualte the gradient
                    job.chi_te_temp = job.chi_te;
                    delta_alpha_temp = delta_alpha;
                    % apply change within limits
                    if abs(dchi_te)<3
                        job.chi_te = job.chi_te - dchi_te;
                    else
                        job.chi_te = job.chi_te - 1*sign(dchi_te);
                    end
                    tot_cam = job.chi_le - job.chi_te;
                    disp(['*****Total camber is: ' num2str(tot_cam) ' ******'])
                    
                    %% ADJUST FRACTION chord
                    [job]=ts_frac_chord_mises(job,[],2); % mode 2 - between shock and covered passage
                    
                    [q,h,job] = mis_run_section(directory,[],[0,0,1],0,1,1,job);
                    if q.manual == 0
                        [Polarx, Ises] = mis_read_polarx('mises',directory);
                        if size(Polarx.sout,2) == 1
                            [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                            P_ratio = Polarx.p2pt./Polarx.p1pt;
                        else
                            [~,i_des] = min(abs(Polarx.binl-(Ises.binl)));
                            Polarx.sout = Polarx.sout(i_des);
                            P_ratio = Polarx.p2pt(i_des)./Polarx.p1pt(i_des);
                        end
                        [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                    else
                        % rerun at intermiediate camber to give a chance to
                        % converge
                        disp('***Converged solution wasnt reached try changing the total camber again****');
                        n_iter_max = 4;
                        n_iter = 1;
                        while q.manual == 1 && n_iter < n_iter_max
                            job.chi_te_new = 0.40*job.chi_te_temp + 0.60*job.chi_te;
                            job.chi_te_temp = job.chi_te;
                            job.chi_te = job.chi_te_new;
                            [q,h,job] = mis_run_section(directory,[],[0,0,1],0,1,1,job);
                            if q.manual == 1
                                disp(['******Cannot run at this total camber ' num2str(job.chi_le-job.chi_te) ' ******'])
                            else
                                [Polarx, Ises] = mis_read_polarx('mises',directory);
                                if size(Polarx.sout,2) == 1
                                    [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                                    P_ratio = Polarx.p2pt./Polarx.p1pt;
                                else
                                    [~,i_des] = min(abs(Polarx.binl-(Ises.binl)));
                                    Polarx.sout = Polarx.sout(i_des);
                                    P_ratio = Polarx.p2pt(i_des)./Polarx.p1pt(i_des);
                                end
                                [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                            end
                            n_iter = n_iter + 1;
                        end
                        if n_iter >= n_iter_max
                            disp('***** Converged solution was NOT reached *****')
                            break
                        end
                    end
                    
                    
                    ni = ni + 1;
                    
                    save([directory 'job.mat'],'job')
                end
                
                
                save([directory 'job.mat'],'job')
                
                if ni>=n_max
                    disp('***Cant get target exit flow angle within maximum number of iterations****');
                    job.conv = -1;
                elseif  q.manual == 1
                    disp('***Intermediate MISES solution did not converge****');
                    job.conv = 0;
                else
                    disp('*** Solution has converged; run loss loop ****');
                    [q,h,job] = mis_run_section(directory,[],[0,0,1],0,1,0,job);
                    if q.manual == 0
                        [Polarx, Ises] = mis_read_polarx('mises',directory);
                        if size(Polarx.sout,2) == 1
                            [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                            P_ratio = Polarx.p2pt./Polarx.p1pt;
                        else
                            [~,i_des] = min(abs(Polarx.binl-(Ises.binl)));
                            Polarx.sout = Polarx.sout(i_des);
                            P_ratio = Polarx.p2pt(i_des)./Polarx.p1pt(i_des);
                        end
                        
                        % store init and chi_le for initial values for next
                        % iteration
                        init = job.chi_te - job.f.Alpha2 + 1;
                        chi_le_guess = job.chi_le;
                        
                        % get better guess for polytropic efficiency and exit
                        % mach number for next iteration
                        syms np_var
                        np_new = vpasolve(P_ratio == (1+(ga-1)./2.*f.M.^2.*(1-job.DeHaller.^2))^(ga.*np_var./(ga-1)),np_var,[0,1])
                        if isempty(np_new)==1
                            np_new =0.95;
                        end
                        job.np = double(np_new);
                        [f]=mises_output_finput(job,mode);
                        job.f = f;
                        job.f.M = job.Mrel_inlet;
                        
                    else
                        disp('*** Loss loop has not converged ****');
                    end
                    delta_alpha = atand( Polarx.sout ) - alpha_tar;
                    disp(['****** Difference between target and true exit flow angle: ' num2str(delta_alpha) ' degrees *****'])
                    job.conv = 1;
                end
                
                job.dalpha = delta_alpha;
                save([directory 'job.mat'],'job')
                
            end
            
        end
        
    end
end

% 	% run chic
% 	if size(Polarx.sout,2) == 1
% 		disp('***Running chic***')
% 		[p,h,job] = mis_run_section(directory,[],[0,0,1],0,1,0,job);
% 	end
