% filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};

% filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};

% filename = {'M090SC100a_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100i_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100a_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100i_no_hade'};

filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade'};

filename = {'M090SC90j_no_hade_load_coef','M090SC90i_no_hade_load_coef','M090SC90a_no_hade_load_coef','M090SC90e_no_hade_load_coef','M090SC90g_no_hade_load_coef','M090SC90d_no_hade_load_coef','M090SC90h_no_hade_load_coef'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = filename;

% filename = {'M090SC100g_no_hade'};
% outnames = {'_SA_4_0'};
% rjm_directory = {'M090SC100g_no_hade'};

%% Mt=0.79; M=0.90; changing s/c;
% shorter list
% filename = {'RMCA0669a2','M09SC110','M09SC100c','M090SC090','M090SC080','M090SC070'};
% outnames = {'C5_SA_4','_SA_4_0','S4_SA_4','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'RMCA0669a2','M09SC110','M09SC100c','M090SC090','M090SC080','M090SC070'};

% filename = {'M090SC70_s_c_no_hade','M090SC80_s_c_no_hade','M090SC90_s_c_no_hade','M090SC100_s_c_no_hade','M090SC110_s_c_no_hade','M090SC120_s_c_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC70_s_c_no_hade','M090SC80_s_c_no_hade','M090SC90_s_c_no_hade','M090SC100_s_c_no_hade','M090SC110_s_c_no_hade','M090SC120_s_c_no_hade'};
% 
% %% M090SC100_thickness 2%
% filename = {'M090SC100j_no_hade_load_coef_2%','M090SC100i_no_hade_load_coef_2%','M090SC100a_no_hade_load_coef_2%','M090SC100e_no_hade_load_coef_2%','M090SC100g_no_hade_load_coef_2%','M090SC100d_no_hade_load_coef_2%','M090SC100h_no_hade_load_coef_2%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% rjm_directory = filename;
% 
% %% M090SC100 thickness 3%
% filename = {'M090SC100j_no_hade_load_coef_3%','M090SC100i_no_hade_load_coef_3%','M090SC100a_no_hade_load_coef_3%','M090SC100e_no_hade_load_coef_3%','M090SC100g_no_hade_load_coef_3%','M090SC100d_no_hade_load_coef_3%','M090SC100h_no_hade_load_coef_3%','M090SC100j_no_hade3_3%','M090SC100j_no_hade4_3%','M090SC100g_no_hade2_3%','M090SC100g_no_hade3_3%','M090SC100l_no_hade_3%','M090SC100m_no_hade_3%','M090SC100n_no_hade_3%','M090SC100p_no_hade_3%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% rjm_directory = filename;
% %%
% 
% %% M090SC100 A98%
% filename = {'M090SC100j_no_hade_load_coef_A98%','M090SC100i_no_hade_load_coef_A98%','M090SC100a_no_hade_load_coef_A98%','M090SC100e_no_hade_load_coef_A98%','M090SC100g_no_hade_load_coef_A98%','M090SC100d_no_hade_load_coef_A98%','M090SC100h_no_hade_load_coef_A98%','M090SC100j_no_hade3_A98%','M090SC100j_no_hade4_A98%','M090SC100g_no_hade2_A98%','M090SC100g_no_hade3_A98%','M090SC100l_no_hade_A98%','M090SC100m_no_hade_A98%','M090SC100n_no_hade_A98%','M090SC100p_no_hade_A98%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = filename;

filename = {'M090SC100d_no_hade'};
outnames = {'_SA_4_0'};
rjm_directory = filename;

%% M090SC080
% filename = {'M090SC80j_no_hade_load_coef','M090SC80i_no_hade_load_coef','M090SC80a_no_hade_load_coef','M090SC80e_no_hade_load_coef','M090SC80g_no_hade_load_coef','M090SC80d_no_hade_load_coef','M090SC80h_no_hade_load_coef','M090SC80j_no_hade3','M090SC80j_no_hade4','M090SC80g_no_hade2','M090SC80g_no_hade3','M090SC80l_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% % filename = [ filename {'M090SC80_70_no_hade','M090SC80_80_no_hade','M090SC80_90_no_hade','M090SC80_80_no_hade','M090SC80_110_no_hade'}];
% rjm_directory = filename;
%%
%% inlet Mach = 0.65;
filename = {'M065SC75j_no_hade','M065SC75i_no_hade','M065SC75a_no_hade','M065SC75e_no_hade','M065SC75g_no_hade'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};

%% inlet Mach = 1.10
filename = {'M110SC90j_no_hade','M110SC90i_no_hade','M110SC90l_no_hade','M110SC90m_no_hade','M110SC90n_no_hade'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110SC90j_no_hade','M110SC90i_no_hade','M110SC90l_no_hade','M110SC90m_no_hade','M110SC90n_no_hade'};

filename = {'M110bSC90j_no_hade','M110bSC90i_no_hade','M110bSC90l_no_hade','M110bSC90m_no_hade','M110bSC90n_no_hade'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110bSC90j_no_hade','M110bSC90i_no_hade','M110bSC90l_no_hade','M110bSC90m_no_hade','M110bSC90n_no_hade'};

% different camber distributions
filename = {'M110SC90a1_psi035DH070','M110SC90a2_psi035DH070','M110SC90a3_psi035DH070','M110SC90a4_psi035DH070','M110SC90a5_psi035DH070','M110SC90a6_psi035DH070','M110SC90a7_psi035DH070'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110SC90a1_psi035DH070','M110SC90a2_psi035DH070','M110SC90a3_psi035DH070','M110SC90a4_psi035DH070','M110SC90a5_psi035DH070','M110SC90a6_psi035DH070','M110SC90a7_psi035DH070'};

% filename = {'M110SC90a4_psi035DH070','M110SC90a5_psi035DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = filename;

% % different inlet flow angles camber c3 deltakss/deltak = 0.001 s/c =0.80
% filename = {'M110SC80a3_psi035DH070','M110SC80b3_psi035DH070','M110SC80c3_psi035DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC80a3_psi035DH070','M110SC80b3_psi035DH070','M110SC80c3_psi035DH070'};
% 
% % different inlet flow angles camber c2 deltakss/deltak = 0.10, s/c =0.8
% filename = {'M110SC90f2_psi035DH070','M110SC90b2_psi035DH070','M110SC90c2_psi035DH070','M110SC90d2_psi035DH070','M110SC90e2_psi035DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC90f2_psi035DH070','M110SC90b2_psi035DH070','M110SC90c2_psi035DH070','M110SC90d2_psi035DH070','M110SC90e2_psi035DH070'};
% % 
% filename = {'M110SC90a3_psi035DH070'};
% outnames = {'_SA_4_0'};
% rjm_directory = {'M110SC90a3_psi035DH070'};

% % 53 degrees joint location a3
% filename = {'M110SC90a3_psi035DH070_joint5','M110SC90a3_psi035DH070_joint1','M110SC90a3_psi035DH070_joint6'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC90a3_psi035DH070_joint5','M110SC90a3_psi035DH070_joint1','M110SC90a3_psi035DH070_joint6'};
% 
% 
% % % different inlet flow angles camber c2 deltakss/deltak = 0.20, s_c=0.90;
% % filename = {'M110SC90b1_psi035DH070','M110SC90c1_psi035DH070'};
% % outnames = {'_SA_4_0','_SA_4_0','_SA_4_0'};
% % rjm_directory = {'M110SC90b1_psi035DH070','M110SC90c1_psi035DH070'};
% 
% % % % 60 degree angle different cambers
% filename = {'M110SC90c1_psi035DH070','M110SC90c2_psi035DH070','M110SC90c3_psi035DH070','M110SC90c5_psi035DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC90c1_psi035DH070','M110SC90c2_psi035DH070','M110SC90c3_psi035DH070','M110SC90c5_psi035DH070'};
% % 
% % % % 60 degree angle different cambers (load_coef = 0.40)
% filename = {'M110SC90c1_psi040DH070','M110SC90c2_psi040DH070','M110SC90c3_psi040DH070','M110SC90c5_psi040DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC90c1_psi040DH070','M110SC90c2_psi040DH070','M110SC90c3_psi040DH070','M110SC90c5_psi040DH070'};

%% supersonic select load_coef = 0.35, DH = 0.70
% filename = {'M105bSC90i_no_hade','M110eSC90l_no_hade','M120SC90n_no_hade','M130bSC90m_no_hade'} ;
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M105bSC90m_no_hade','M110eSC90l_no_hade','M120SC90n_no_hade','M130bSC90l_no_hade'};


% filename = {'M110bSC90i_no_hade'};
% outnames = {'_SA_4_0'};
% rjm_directory = {'M110bSC90i_no_hade'};

% %Different proportions of supersonic camber: M = 1.20 & 60 degree angle different cambers thickness = 2.0%  dH=0.7 & Ax2/Ax1=0.90 & alpha_inlet=0 & s/c=0.90 & np =0.92
filename = {'M120SC90a1_psi035DH070et3','M120SC90a2_psi035DH070et3','M120SC90a3_psi035DH070et3','M120SC90a4_psi035DH070et3','M120SC90a5_psi035DH070et3','M120SC90a6_psi035DH070et3'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = filename;


% filename = {'M120SC90a4_psi035DH070et3'};
% outnames = {'_SA_4_0'};
% rjm_directory = filename'
% M = 1.1;
% Ax = 1;
% 
filename = {'M120SC90c5_psi035DH070et2b'};
outnames = {'_SA_4_0'};
rjm_directory = filename'

M = 1.1;
Ax = 0.87;


% thick = [0.08 0.07 0.06 0.05 0.04 0.03 0.02 0.015];
thick = [0.05 0.04 0.03 0.02 0.015];

% thick_name = {'t2','t5','t6b','t6','t7','t3','t2b','t1'};
thick_name = {'t6','t7','t3','t2b','t1'};

Minlet_sweep = [1.05, 1.15, 1.25,  1.3];

Minlet = [1.3];

alpha_inlet = [45, 50, 55, 60, 65];
alpha_inlet = [60];

alpha_name = {'c'};

perc_cam = [0.001 -0.05 -0.1 -0.15 -0.2];
camber_name = {'5','6','7','8','9'};

perc_cam = [0.25 0.2 0.15 0.1 0.05 0.001 -0.05 -0.1 -0.15 -0.2 -0.25];
camber_name = {'0' '1' '2' '3','4','5','6','7','8','9','10'};

% perc_cam = [0.25 0.2 0.15 0.1 0.05 0.001 -0.05 -0.1];
% camber_name = {'0' '1' '2' '3','4','5','6','7'};
% 
% perc_cam = [0.45 0.40 0.35 0.30 0.25 0.2 0.15 0.1 0.05 0.001 -0.05 -0.1];
% camber_name = {'4b' '3b' '2b' '1b' '0b' '1' '2' '3','4','5','6','7'};


% perc_cam = [0.001 -0.05 -0.1 -0.15 -0.2];
% camber_name = {'5','6','7','8','9'};

% perc_cam = [-0.05 -0.1 -0.15 ];
% camber_name = {'6','7','8'};


% perc_cam = [-0.075 -0.10];
% camber_name = {'6b','7b'};
% 
% perc_cam = [-0.20 -0.15 -0.10 -0.05];
% camber_name = {'9c','8c','7c','6c'};

s_c_target = [0.90];

deHaller = [0.65 0.675];

% set exit airflow angle
% alpha_tar = job.f.Alpha2

color = [0,0,1;1,0,0;0,0.5,0;1,0,1;0.5,0,0.5;0.5,0.5,0.5;0,0,0;0.25,0.25,0.25;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0];
Linestyle = {'-','--',':','-.','-','-','-','-','-','-'};
n=figure;
grid on; hold on;

clear local_inc
clear tot_cam
clear H_TE loss dalpha_sort

tot_cam = [];

% for l = 1:length(Minlet_sweep)

var = 'perc_cam';

for m = 1:length(sweep.(var))
	
	clear tot_cam local_inc H_TE loss dalpha_sort i_sort inlet_cam_guess
	tot_cam = [];
	
for i = 1:length(filename)
	
	directory = ['/home/dl467/Documents/Test_Cases/' filename{i} '/MISES/' ]
	cd(directory)
	mis_directory = strrep(directory,'TURBOSTREAM','MISES');
	load([mis_directory 'job.mat']);
	load([mis_directory 'section.mat']);
	%% change geometric parameters i.e. thickness-to-chord and pitch-to-chord
% % 	job.t.thick_chord = 0.03;
% % 	s_c = s_c_target(m);
% 	job.t.thick_chord = 0.02/0.90*s_c;
% 	job.t.thick_chord = 0.014;
% % 	job.t.thick_chord = thick(m);
% % 	s_c = 0.8331;
% % 	job.r_le = 0.1461;
% % 	job.r_te = 0.1439;

    if strcmp(sweep_var,'s_c')==1
        s_c = sweep.s_c{m};
    end
    
    if strcmp(sweep_var,'t_c')==1
        job.t.thick_chord = sweep.t_c{m};
    else
        job.t.thick_chord = t_c;
    end

    
    %% ADJUST FRACTION chord
	[job]=ts_frac_chord_mises(job);
	%% set polytropic efficiency
	np = 0.92;
	job.np = np;

	%% change aeroparameters
	job.load_coef = 0.35;
	if exist('inlet_cam_guess','var')==0
	% initial guess
	job.inlet_cam = 57.22;
	job.inlet_cam = 62.82;
% 	job.inlet_cam = alpha_inlet(m)-2.5;
	else % use previous solution as a better initial guess
		job.inlet_cam = inlet_cam_guess;
		disp(['Guess for inlet cam ' num2str(inlet_cam_guess)])
	end
% 	job.DeHaller = 0.716;
	job.DeHaller = 0.70;
% 	job.DeHaller = deHaller(m);
	%% change streamtube contraction
	job.f.Ax = 0.86;
% 	job.f.Ax = 1/1.1145;
	%% change inlet flow angle (or U/cpTo1) and Mach number
% 	job.alpha_rel_inlet =53.3929;
% 	job.alpha_inlet = 10.8855;
	job.alpha_rel_inlet =60;
% 	job.alpha_rel_inlet =alpha_inlet(m);
	job.alpha_inlet = 0;
% 	job.Mrel_inlet = Minlet_sweep(l);
	M = 1.2;
	job.Mrel_inlet = M;
	%%
	
	mode = 2; % mode 1: constant psui & dh; mode 2: contant psi & Area ratio; mode 3: constnat dH and Area ratio
	[f]=mises_output_finput(job,mode);
	job.f = f;
	job.f.M = job.Mrel_inlet;
	

	%%
	% 	job.f.Ax = Ax;
	% set exit airflow angle
	alpha_tar = job.f.Alpha2;

	job.tot_cam = job.f.Alpha - job.f.Alpha2 - 1.5;
% 	job.tot_cam = 0.7;
% 	job.tot_cam = job.f.Alpha - job.f.Alpha2 + 3;
	job.tot_cam_temp = job.tot_cam;
	
	pitch = 2*pi*job.high_radius/job.N_high;
	
	%%
% 	s_c = pitch/job.chord
	%%
	if length(s_c)==1
	pitch = s_c*job.chord;
	else
		pitch = s_c(i)*job.chord;
	end
	job.N_high = ceil(2*pi*job.high_radius/pitch);
	
	% name of new directory
	ind = strfind(filename(i),'_'); 
	ext = filename{i}(ind{1}(1)-2:end);
	%% new just camber description
% 	ext=filename{i}(ind{1}(1)-2:ind{1}(1)-1;
	ext=[ 'c' filename{i}(ind{1}(1)-1:ind{1}(1)-1)];
	ext=[ 'c' camber_name{m}];
% 	ext=[ 'c11'];
	job.percentage_cam = perc_cam(m);
% 	job.percentage_cam = -0.40;
% 	ext=[ alpha_name{m} filename{i}(ind{1}(1)-1:ind{1}(1)-1)];
	
	%%
% 	ext = 'c2_psi030DH070';
% % 	%% don't forget to change
	ext2 = ['_psi0' num2str(100*job.load_coef) 'A' num2str(round(100*job.f.Ax))];
% % 	ext2 = ['_DH0' num2str(100*job.DeHaller) 'A' num2str(round(100*job.f.Ax))];
% 	ext2 = ['_psi0' num2str(100*job.load_coef) 'DH0'  num2str(100*job.DeHaller)];
% 	ext2 = '';
% 	ext3 = thick_name{m};
	%%
	if length(s_c)==1
	directory = ['mnt/Disk1/dl467/Documents/Test_Cases/M' num2str(round(100*M)) 'SC' num2str(round(100*s_c)) ext ext2 'e' 't15D' '/MISES/']
	else
		directory = ['mnt/home/dl467/Documents/Test_Cases/M' num2str(round(100*M)) 'SC' num2str(round(100*s_c(i))) ext ext2 't15D' '/MISES/']
	end
	job.directory = directory;
	job.rjm_directory = directory;
	
	

	if exist(directory,'dir') == 0
		
		%% re calculate inlet blade metal angle
	if exist(directory,'dir') == 0
    [beta_i,M_s]=unique_incidence_detached_contr_MCA2(job,s_c*job.chord,M,[],0);
	deltai = beta_i - job.inlet_cam;
	job.inlet_cam = job.alpha_rel_inlet - deltai;
	inlet_cam = job.inlet_cam;
	end
		
    %% run until you have correct guess for total camber
	p=[];
	p.manual = 1;
	n_initial = 1;
	while p.manual == 1 && n_initial < 10
		disp(['Cannot run at this total camber ' num2str(job.tot_cam)])
		[p,h,~] = mis_run_section_ss(directory,[],[0,0,1],0,1,1,job);
		job.tot_cam = job.tot_cam + 0.20;
		n_initial = n_initial + 1
	end
	if n_initial >= 10
		('***** Cannot run initial solution try again*****')
		break
	end
	%%
	
    % iteration number
	ni = 1;
	n_HTE_max = 10;
	n_type_max = 5;
	beta=1;
	beta_temp = beta;
	dtot_cam = 1.0;
	job.tot_cam_temp = job.tot_cam;
	
	%
	[Polarx, Ises] = mis_read_polarx('mises',directory);
	if size(Polarx.sout,2) == 1
	[p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
	else
		[~,i_des] = min(abs(Polarx.binl-(Ises.binl)));
		Polarx.sout = Polarx.sout(i_des);
		Polarx.binl = Polarx.binl(i_des);
	end
	
	% Read in the grid coodinates
	if exist([directory 'idat.mises_01'],'file') ~= 0
		Idat = mis_read_idat('mises_01',directory);
	else
		Idat = mis_read_idat('mises',directory);
	end
	load([directory 'section.mat']);
	mt_stag = [Idat.x(Idat.ninl(2),end) Idat.y(Idat.ninl(2),end)];
	phi_stag = atan2(c.mt_le_cen(2) - mt_stag(2),c.mt_le_cen(1) - mt_stag(1)) * 360 / (2*pi)
	[p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
	p.manual = 0;
	
	abs(phi_stag-c.chi_le)
	dtot_cam
	ni<n_HTE_max
	abs(phi_stag-c.chi_le)>0.05 && dtot_cam>0.1 && ni<n_HTE_max
	
	while dtot_cam>0.1 && ni<n_HTE_max
		
		abs(phi_stag-c.chi_le)
		
		save([directory 'job_temp.mat'],'job');
		load([directory 'section.mat']);
		
		dalpha = beta.*(phi_stag-c.chi_le);
		
		dalpha_sort(ni,i) = dalpha;
		
		if p.manual == 0
		tot_cam(ni,i) = job.tot_cam_temp;
		local_inc(ni,i) = phi_stag-c.chi_le;
		H_TE(ni,i) = p.Hb_te;
		loss(ni,i) = Polarx.omega;
		else
			tot_cam(ni,i) = job.tot_cam_temp;
			local_inc(ni,i) = 0;
			H_TE(ni,i) = 0;
			loss(ni,i) = 0;
		end

		
		% sort by increasing camber
		[tot_cam(:,i),i_sort]=sort(tot_cam(:,i),'descend')
		local_inc(:,i) = local_inc(i_sort,i)		
		H_TE(:,i) = H_TE(i_sort,i);
		loss(:,i) = loss(i_sort,i)
		dalpha_sort(:,i) = dalpha_sort(i_sort,i);
		

		
		% Interpolate to find current maximum pressure rise point
		if ni ~= 1 && beta<beta_temp
			
			% Generate flow coefficient vector to interpolate
			tot_cam_dummy = tot_cam(:,i);
			tot_cam_dummy(tot_cam_dummy==0)=[];
			[tot_cam_dummy,i_unique] = unique(tot_cam_dummy,'stable')

			tot_cam_interp = [linspace(tot_cam_dummy(1),tot_cam_dummy(end),100)];
			tot_cam_interp = unique(tot_cam_interp,'stable');
			
			loss_dummy = loss(:,i);
% 			loss_dummy(loss_dummy==0)=NaN;
			loss_dummy = loss_dummy(i_unique)
			% Spline all points
			loss_interp = interp1(tot_cam_dummy,loss_dummy,tot_cam_interp,'pchip');
			
			% Find the point previous to the maximum
			[~,i_min] = min(loss_interp); loss_min = loss_interp(i_min)
			i_current = find(loss_dummy <= loss_min,1,'last')
			i_current = min(i_current)
			
			dalpha_dummy = dalpha_sort(:,i);
			dalpha_dummy(dalpha_dummy==0)=NaN;
			dalpha_dummy = dalpha_dummy(i_unique);
			
			
			if i_current<length(tot_cam_dummy)
			job.tot_cam = tot_cam_dummy(i_current+1);
			tot_cam_temp = tot_cam_dummy(i_current+1)
			loss_temp = loss_dummy(i_current+1);
			dalpha = dalpha_dummy(i_current+1)
			else
				job.tot_cam = tot_cam_dummy(i_current);
				tot_cam_temp = tot_cam_dummy(i_current)
				loss_temp = loss_dummy(i_current);
				dalpha = dalpha_dummy(i_current)
			end
			beta_temp = beta
			
		elseif ni==1
			loss_temp = loss(ni,i)
			tot_cam_temp = tot_cam(ni,i);
			tot_cam_dummy = tot_cam(:,i);
			loss_dummy = loss(:,i);
			dalpha_dummy = dalpha_sort(:,i);
		end
		
		job.tot_cam_dummy = tot_cam_dummy;
		job.loss_dummy = loss_dummy;
		job.local_inc_dummy = dalpha_dummy;
		save([directory 'job.mat'],'job')
		
		%% set dalpha
		dalpha = 0.5;
		%%
		
		if abs(dalpha)<1.0
			job.tot_cam_temp = job.tot_cam +  beta.*dalpha;
		else
			job.tot_cam_temp = job.tot_cam +  0.5*beta.*sign(dalpha);
		end

		
% 		% make sure it is realistic
% 		if job.tot_cam_temp+job.inlet_cam<alpha_tar
% 			disp('******Removed unreasonable amount of camber****')
% 			job.tot_cam_temp=alpha_tar-job.inlet_cam+1.5;
% 		end
% 		job.percentage_cam_temp = job.percentage_cam * job.tot_cam/job.tot_cam_temp;
		job.tot_cam = job.tot_cam_temp;
% 		job.percentage_cam = job.percentage_cam_temp;

		save([directory 'job.mat'],'job');
		[p,h,job] = mis_run_section_ss(directory,[],[0,0,1],0,1,1,job);
		%% check if initial guess for tot_cam is correct

		if p.manual == 1
			disp('Cannot run at this total camber')
% 			job.tot_cam = job.tot_cam +  beta*dalpha;
			job.tot_cam = job.tot_cam +  0.5*dalpha;
			ni = ni+1;
			%% Half the mass flow step
% 			beta = 0.5 * beta
			continue
		end
		
		%%
		
		[Polarx, Ises] = mis_read_polarx('mises',directory);
		[p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
		p.manual = 0;
		bout = atand(Polarx.sout);
		Idat = mis_read_idat('mises',directory);
		load([directory 'section.mat']);
		
		mt_stag = [Idat.x(Idat.ninl(2),end) Idat.y(Idat.ninl(2),end)];
		phi_stag = atan2(c.mt_le_cen(2) - mt_stag(2),c.mt_le_cen(1) - mt_stag(1)) * 360 / (2*pi);
		
		ni = ni+1;
		tot_cam(ni,i) = job.tot_cam;
		local_inc(ni,i) = phi_stag-c.chi_le;
		H_TE(ni,i) = p.Hb_te;
		loss(ni,i) = Polarx.omega;
		
		
		% Record pressure rise value and update next point
        dloc_inc = local_inc(ni,i) - local_inc(ni-1); ni_current = length(local_inc(:,i));
		dloss = loss(ni,i)-loss_temp
		loss_temp = loss(ni,i);
		%% Check tot_cam tolerance
		dtot_cam = abs(tot_cam(ni,i)-tot_cam_temp)
		
		if dtot_cam<0.1
			display('Converged to total camber tolerance');
		end
		if abs(phi_stag-c.chi_le)<0.15
			display('Converged on local incidence');
		end
		
		if dloss>0.010
		%% Half the mass flow step
		beta = 0.5 * beta
		end
		
		
	%% ADJUST FRACTION chord
		[job]=ts_frac_chord_mises(job);
		
		abs(phi_stag-c.chi_le)
		dtot_cam
		ni<n_HTE_max
		abs(phi_stag-c.chi_le)>0.02 && dtot_cam>0.1 && ni<n_HTE_max
		
	end
	
	% sort by increasing camber
	[tot_cam(:,i),i_sort]=sort(tot_cam(:,i),'descend');
	local_inc(:,i) = local_inc(i_sort,i);
	H_TE(:,i) = H_TE(i_sort,i);
	loss(:,i) = loss(i_sort,i);
	dalpha = beta.*(phi_stag-c.chi_le);
	if size(tot_cam,1) > size(dalpha_sort,1)
	dalpha_sort(ni,i) = dalpha;
	end
	dalpha_sort(:,i) = dalpha_sort(i_sort,i);
	
	if ni>n_HTE_max
		disp('***Cant fix H_TE - need to fix manually****');
	end
	
	%% run minimum loss incidence
	
	% Generate flow coefficient vector to interpolate
	tot_cam_dummy = tot_cam(:,i);
	loss_dummy = loss(:,i);
	tot_cam_dummy(loss_dummy==0)=[];
	tot_cam_interp = tot_cam_dummy(1);
	[tot_cam_dummy,i_unique] = unique(tot_cam_dummy,'stable');
	
	tot_cam_interp = [linspace(tot_cam_interp,tot_cam_dummy(end),100)];
	tot_cam_interp = unique(tot_cam_interp,'stable');
	
	loss_dummy(loss_dummy==0)=[];
	loss_dummy = loss_dummy(i_unique);
	% Spline all points
	loss_interp = interp1(tot_cam_dummy,loss_dummy,tot_cam_interp,'pchip');
	
	dalpha_dummy = dalpha_sort(:,i);
	dalpha_dummy(loss_dummy==0)=[];
	dalpha_dummy = dalpha_dummy(i_unique);
	
	% Find the point previous to the maximum
	[~,i_min] = min(loss_interp); loss_min = loss_interp(i_min);
	i_current = find(loss_dummy <= loss_min,1,'last');
	job.tot_cam = tot_cam_dummy(i_current);
	tot_cam_temp = tot_cam_dummy(i_current);
	loss_temp = loss_dummy(i_current);
	
	
	job.tot_cam_dummy = tot_cam_dummy;
	job.loss_dummy = loss_dummy;
	job.local_inc_dummy = dalpha_dummy;
	save([directory 'job.mat'],'job')
	run_single = 0;
	[p,h,job] = mis_run_section_ss(directory,[],[0,0,1],0,1,run_single,job);

	% new guess for inlet cam
	inlet_cam_guess = job.inlet_cam
	
	%% make plot
	
	figure(n); grid on; hold on;
	tot_cam_plot = tot_cam(:,i);
	local_inc_plot = local_inc(:,i);
	local_inc_plot(local_inc_plot==0)=NaN;
	loss_plot = loss(:,i);
	loss_plot(loss_plot==0)=NaN;
	[hAx,hLine1,hLine2]=plotyy(tot_cam_plot,loss_plot,tot_cam_plot,local_inc_plot);
% 	ylabel('Local incidence \phi_{stag}-\chi_{le}')
	xlabel('Total camber \chi_{2}-\chi_{1}')
	ylabel(hAx(2),'Local incidence \phi_{stag}-\chi_{le}')
	% 	ylabel(hAx(2),'H_{TE}')
	ylabel(hAx(1),'Profile loss (Y_{p})')
	hAx(1).YColor=[0 0 1];
	hAx(2).YColor=[1,0,0];
	
	hLine1.Marker= 'x';
	hLine1.Color=color(m,:);
	hLine2.Marker= 'o';
	hLine2.Color=color(m,:);
	hLine1.LineWidth=1.1;
	hLine2.LineWidth=1.1;
	hLine2.LineStyle='--';
% 	hAx(1).XLim = [9-2,9+2];
% 	hAx(1).YLim = [0,0.1];
% 	hAx(2).XLim = [9-2,9+2];
% 	hAx(2).YLim = [0,2];
	
	
% 	% run chic
% 	if size(Polarx.sout,2) == 1
% 		disp('***Running chic***')
% 		[p,h,job] = mis_run_section(directory,[],[0,0,1],0,1,0,job);
% 	end

     
	end
end
			
%% plot after having all the data not sequentially 
for i=1:size(tot_cam,2)
	figure(n); grid on; hold on;
	tot_cam_plot = tot_cam(:,i);
	local_inc_plot = local_inc(:,i);
	local_inc_plot(local_inc_plot==0)=NaN;
	loss_plot = loss(:,i);
	loss_plot(loss_plot==0)=NaN;
	if isempty(tot_cam_plot)==0
% 	[hAx,hLine1,hLine2]=plotyy(tot_cam_plot,loss_plot,tot_cam_plot,local_inc_plot);
	[hAx]=plot(tot_cam_plot,loss_plot,'LineWidth',1.1,'Color',color(m,:),'Marker','x');
	xlabel('Total camber \chi_{2}-\chi_{1}')
	ylabel('Profile loss (Y_{p})')
% 	ylabel(hAx(2),'Local incidence')
% 	ylabel(hAx(2),'H_{TE}')
% 	ylabel(hAx(1),'Profile loss (Y_{p})')
% 	hAx(1).YColor=[0,0,1];
% 	hAx(2).YColor=[1,0,0];

% 	hLine1.Marker= 'x';
% 	hLine1.Color=[0,0,1];
% 	hLine1.LineStyle=Linestyle{i};
% 	hLine2.Marker= 'o';
% 	hLine2.Color=[1,0,0];
% 	hLine2.LineStyle=Linestyle{i};
% 	hLine1.LineWidth=1.1;
% 	hLine2.LineWidth=1.1;
% 	hLine2.LineStyle='--';
% 	hAx(1).XLim = [8,12];
% 	hAx(1).YLim = [0,0.07];
% 	hAx(2).XLim = [8,12];
% 	hAx(2).YLim = [-0.3,2];

	end
end


end

% end
% %%