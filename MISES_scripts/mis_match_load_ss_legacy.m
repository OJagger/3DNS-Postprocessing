% filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};

% filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};

% filename = {'M090SC100a_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100i_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100a_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100i_no_hade'};

filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade'};

filename = {'M090SC90j_no_hade_load_coef','M090SC90i_no_hade_load_coef','M090SC90a_no_hade_load_coef','M090SC90e_no_hade_load_coef','M090SC90g_no_hade_load_coef','M090SC90d_no_hade_load_coef','M090SC90h_no_hade_load_coef'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = filename;

% filename = {'M090SC100g_no_hade'};
% outnames = {'_SA_4_0'};
% rjm_directory = {'M090SC100g_no_hade'};

%% Mt=0.79; M=0.90; changing s/c;
% shorter list
% filename = {'RMCA0669a2','M09SC110','M09SC100c','M090SC090','M090SC080','M090SC070'};
% outnames = {'C5_SA_4','_SA_4_0','S4_SA_4','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'RMCA0669a2','M09SC110','M09SC100c','M090SC090','M090SC080','M090SC070'};

% filename = {'M090SC70_s_c_no_hade','M090SC80_s_c_no_hade','M090SC90_s_c_no_hade','M090SC100_s_c_no_hade','M090SC110_s_c_no_hade','M090SC120_s_c_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC70_s_c_no_hade','M090SC80_s_c_no_hade','M090SC90_s_c_no_hade','M090SC100_s_c_no_hade','M090SC110_s_c_no_hade','M090SC120_s_c_no_hade'};
%
% %% M090SC100_thickness 2%
% filename = {'M090SC100j_no_hade_load_coef_2%','M090SC100i_no_hade_load_coef_2%','M090SC100a_no_hade_load_coef_2%','M090SC100e_no_hade_load_coef_2%','M090SC100g_no_hade_load_coef_2%','M090SC100d_no_hade_load_coef_2%','M090SC100h_no_hade_load_coef_2%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% rjm_directory = filename;
%
% %% M090SC100 thickness 3%
% filename = {'M090SC100j_no_hade_load_coef_3%','M090SC100i_no_hade_load_coef_3%','M090SC100a_no_hade_load_coef_3%','M090SC100e_no_hade_load_coef_3%','M090SC100g_no_hade_load_coef_3%','M090SC100d_no_hade_load_coef_3%','M090SC100h_no_hade_load_coef_3%','M090SC100j_no_hade3_3%','M090SC100j_no_hade4_3%','M090SC100g_no_hade2_3%','M090SC100g_no_hade3_3%','M090SC100l_no_hade_3%','M090SC100m_no_hade_3%','M090SC100n_no_hade_3%','M090SC100p_no_hade_3%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% rjm_directory = filename;
% %%
%
% %% M090SC100 A98%
% filename = {'M090SC100j_no_hade_load_coef_A98%','M090SC100i_no_hade_load_coef_A98%','M090SC100a_no_hade_load_coef_A98%','M090SC100e_no_hade_load_coef_A98%','M090SC100g_no_hade_load_coef_A98%','M090SC100d_no_hade_load_coef_A98%','M090SC100h_no_hade_load_coef_A98%','M090SC100j_no_hade3_A98%','M090SC100j_no_hade4_A98%','M090SC100g_no_hade2_A98%','M090SC100g_no_hade3_A98%','M090SC100l_no_hade_A98%','M090SC100m_no_hade_A98%','M090SC100n_no_hade_A98%','M090SC100p_no_hade_A98%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = filename;

filename = {'M090SC100d_no_hade'};
outnames = {'_SA_4_0'};
rjm_directory = filename;

%% M090SC080
% filename = {'M090SC80j_no_hade_load_coef','M090SC80i_no_hade_load_coef','M090SC80a_no_hade_load_coef','M090SC80e_no_hade_load_coef','M090SC80g_no_hade_load_coef','M090SC80d_no_hade_load_coef','M090SC80h_no_hade_load_coef','M090SC80j_no_hade3','M090SC80j_no_hade4','M090SC80g_no_hade2','M090SC80g_no_hade3','M090SC80l_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% % filename = [ filename {'M090SC80_70_no_hade','M090SC80_80_no_hade','M090SC80_90_no_hade','M090SC80_80_no_hade','M090SC80_110_no_hade'}];
% rjm_directory = filename;
%%
%% inlet Mach = 0.65;
filename = {'M065SC75j_no_hade','M065SC75i_no_hade','M065SC75a_no_hade','M065SC75e_no_hade','M065SC75g_no_hade'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};

%% inlet Mach = 1.10
filename = {'M110SC90j_no_hade','M110SC90i_no_hade','M110SC90l_no_hade','M110SC90m_no_hade','M110SC90n_no_hade'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110SC90j_no_hade','M110SC90i_no_hade','M110SC90l_no_hade','M110SC90m_no_hade','M110SC90n_no_hade'};

filename = {'M110bSC90j_no_hade','M110bSC90i_no_hade','M110bSC90l_no_hade','M110bSC90m_no_hade','M110bSC90n_no_hade'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110bSC90j_no_hade','M110bSC90i_no_hade','M110bSC90l_no_hade','M110bSC90m_no_hade','M110bSC90n_no_hade'};

% different camber distributions
filename = {'M110SC90a1_psi035DH070','M110SC90a2_psi035DH070','M110SC90a3_psi035DH070','M110SC90a4_psi035DH070','M110SC90a5_psi035DH070','M110SC90a6_psi035DH070','M110SC90a7_psi035DH070'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110SC90a1_psi035DH070','M110SC90a2_psi035DH070','M110SC90a3_psi035DH070','M110SC90a4_psi035DH070','M110SC90a5_psi035DH070','M110SC90a6_psi035DH070','M110SC90a7_psi035DH070'};

% filename = {'M110SC90a4_psi035DH070','M110SC90a5_psi035DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = filename;

% % different inlet flow angles camber c3 deltakss/deltak = 0.001 s/c =0.80
% filename = {'M110SC80a3_psi035DH070','M110SC80b3_psi035DH070','M110SC80c3_psi035DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC80a3_psi035DH070','M110SC80b3_psi035DH070','M110SC80c3_psi035DH070'};
%
% % different inlet flow angles camber c2 deltakss/deltak = 0.10, s/c =0.8
% filename = {'M110SC90f2_psi035DH070','M110SC90b2_psi035DH070','M110SC90c2_psi035DH070','M110SC90d2_psi035DH070','M110SC90e2_psi035DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC90f2_psi035DH070','M110SC90b2_psi035DH070','M110SC90c2_psi035DH070','M110SC90d2_psi035DH070','M110SC90e2_psi035DH070'};
% %
% filename = {'M110SC90a3_psi035DH070'};
% outnames = {'_SA_4_0'};
% rjm_directory = {'M110SC90a3_psi035DH070'};

% % 53 degrees joint location a3
% filename = {'M110SC90a3_psi035DH070_joint5','M110SC90a3_psi035DH070_joint1','M110SC90a3_psi035DH070_joint6'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC90a3_psi035DH070_joint5','M110SC90a3_psi035DH070_joint1','M110SC90a3_psi035DH070_joint6'};
%
%
% % % different inlet flow angles camber c2 deltakss/deltak = 0.20, s_c=0.90;
% % filename = {'M110SC90b1_psi035DH070','M110SC90c1_psi035DH070'};
% % outnames = {'_SA_4_0','_SA_4_0','_SA_4_0'};
% % rjm_directory = {'M110SC90b1_psi035DH070','M110SC90c1_psi035DH070'};
%
% % % % 60 degree angle different cambers
% filename = {'M110SC90c1_psi035DH070','M110SC90c2_psi035DH070','M110SC90c3_psi035DH070','M110SC90c5_psi035DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC90c1_psi035DH070','M110SC90c2_psi035DH070','M110SC90c3_psi035DH070','M110SC90c5_psi035DH070'};
% %
% % % % 60 degree angle different cambers (load_coef = 0.40)
% filename = {'M110SC90c1_psi040DH070','M110SC90c2_psi040DH070','M110SC90c3_psi040DH070','M110SC90c5_psi040DH070'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M110SC90c1_psi040DH070','M110SC90c2_psi040DH070','M110SC90c3_psi040DH070','M110SC90c5_psi040DH070'};

%% supersonic select load_coef = 0.35, DH = 0.70
% filename = {'M105bSC90i_no_hade','M110eSC90l_no_hade','M120SC90n_no_hade','M130bSC90m_no_hade'} ;
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M105bSC90m_no_hade','M110eSC90l_no_hade','M120SC90n_no_hade','M130bSC90l_no_hade'};


% filename = {'M110bSC90i_no_hade'};
% outnames = {'_SA_4_0'};
% rjm_directory = {'M110bSC90i_no_hade'};

% %Different proportions of supersonic camber: M = 1.20 & 60 degree angle different cambers thickness = 2.0%  dH=0.7 & Ax2/Ax1=0.90 & alpha_inlet=0 & s/c=0.90 & np =0.92
filename = {'M120SC90a1_psi035DH070et3','M120SC90a2_psi035DH070et3','M120SC90a3_psi035DH070et3','M120SC90a4_psi035DH070et3','M120SC90a5_psi035DH070et3','M120SC90a6_psi035DH070et3'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = filename;


% filename = {'M120SC90a4_psi035DH070et3'};
% outnames = {'_SA_4_0'};
% rjm_directory = filename'
% M = 1.1;
% Ax = 1;
%
filename = {'M120SC90c5_psi035DH070et2b'};
outnames = {'_SA_4_0'};
rjm_directory = filename;


% thick = [0.08 0.07 0.06 0.05 0.04 0.03 0.02 0.015];
thick = [0.05 0.04 0.03 0.02 0.015];

% thick_name = {'t2','t5','t6b','t6','t7','t3','t2b','t1'};
thick_name = {'t6','t7','t3','t2b','t1'};

Minlet_sweep = [1.05, 1.15, 1.25,  1.3];

Minlet = [1.3];

alpha_inlet = [45, 50, 55, 60, 65];
alpha_inlet = [60];

alpha_name = {'c'};

perc_cam = [0.001 -0.05 -0.1 -0.15 -0.2];
camber_name = {'5','6','7','8','9'};

perc_cam = [0.25 0.2 0.15 0.1 0.05 0.001 -0.05 -0.1 -0.15 -0.2 -0.25];
camber_name = {'0' '1' '2' '3','4','5','6','7','8','9','10'};

% perc_cam = [0.25 0.2 0.15 0.1 0.05 0.001 -0.05 -0.1];
% camber_name = {'0' '1' '2' '3','4','5','6','7'};
%
% perc_cam = [0.45 0.40 0.35 0.30 0.25 0.2 0.15 0.1 0.05 0.001 -0.05 -0.1];
% camber_name = {'4b' '3b' '2b' '1b' '0b' '1' '2' '3','4','5','6','7'};


% perc_cam = [0.001 -0.05 -0.1 -0.15 -0.2];
% camber_name = {'5','6','7','8','9'};

% perc_cam = [-0.05 -0.1 -0.15 ];
% camber_name = {'6','7','8'};


% perc_cam = [-0.075 -0.10];
% camber_name = {'6b','7b'};
%
% perc_cam = [-0.20 -0.15 -0.10 -0.05];
% camber_name = {'9c','8c','7c','6c'};

s_c_target = [0.90];

deHaller = [0.65 0.675];

% set exit airflow angle
% alpha_tar = job.f.Alpha2

%% ********Everything above is not necessary (kept for history)********

%% figure linestyle and color details details

color = [0,0,1;1,0,0;0,0.5,0;1,0,1;0.5,0,0.5;0.5,0.5,0.5;0,0,0;0.25,0.25,0.25;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0];
Linestyle = {'-','--',':','-.','-','-','-','-','-','-'};

clear sweep inlet_cam_guess

%% inlet variables for sweep

t_c = 2/100;
% sweep.t_c = [2 4 3 5 1]/100;
s_c = 0.90;
job.N = round((2*pi*job.r_mid./job.chord)./s_c);
sweep.s_c = [0.70 0.90 1.0 0.50 1.10];
sweep.s_c = [0.70 0.90 1.0];

alpha_rel_inlet = 60;
% sweep.alpha_rel_inlet = [45 50 55 60 65];
alpha_inlet = 0;
M_inlet = 1.0001;

np = 0.92;
load_coef = 0.35;
% sweep.load_coef = [0.25 0.30 0.35 0.375 0.40 0.45];
% sweep.Ax = [1.05 0.925 1.025];
Ax = 1.0;
dH = 0.66;
mode = 2; % mode 1: constant psi & dh; mode 2: contant psi & Area ratio; mode 3: constnat dH and Area ratio ; mode 4: constant dH and throat area ratio

% extract variable that will be swept
var = fieldnames(sweep);
%%

for m = 1:length(sweep.(var{1}))
    
    % sweep through different perecentage cambers
%     perc_cam = [0.10 0.05 0.001 -0.05 -0.1 -0.15 -0.20 -0.25 -0.30 -0.40];
    perc_cam = [0.30 0.20 0.10 0.001 -0.1 -0.20 -0.30 ];
    for i = 1:length(perc_cam)
        
        job.percentage_cam = perc_cam(i);
        clear tot_cam local_inc H_TE loss dalpha_sort i_sort inlet_cam
        tot_cam = [];
        
        if strcmp(var,'s_c')==1
            s_c = sweep.s_c(m);
            job.N = round((2*pi*job.r_mid./job.chord)./s_c);
        end
        
        if strcmp(var,'t_c')==1
            job.t.thick_chord = sweep.t_c(m);
            t_c = sweep.t_c(m);
        else
            job.t.thick_chord = t_c;
        end

        %% change inlet flow angle (or U/cpTo1) and Mach number
        if strcmp(var,'alpha_rel_inlet')==1
            job.alpha_rel_inlet = sweep.alpha_rel_inlet(m);
            if exist('inlet_cam_guess','var')==0 || isempty(inlet_cam_guess)==0
                % initial guess
                job.inlet_cam = sweep.alpha_rel_inlet(m)-2.5;
            else % use previous solution as a better initial guess
                job.inlet_cam = inlet_cam_guess;
                disp(['Guess for inlet cam ' num2str(inlet_cam_guess)])
            end
        else
            job.alpha_rel_inlet = alpha_rel_inlet;
            
            if exist('inlet_cam_guess','var')==0 || isempty(inlet_cam_guess)==0
                % initial guess
                job.inlet_cam = alpha_rel_inlet-2.5;
            else % use previous solution as a better initial guess
                job.inlet_cam = inlet_cam_guess;
                disp(['Guess for inlet cam ' num2str(inlet_cam_guess)])
            end
        end
        
        if strcmp(var,'alpha_inlet')==1
            job.alpha_inlet = sweep.alpha_inlet(m);
        else
            job.alpha_inlet = alpha_inlet;
        end
        
        if strcmp(var,'M_inlet')==1
            job.Mrel_inlet = sweep.M_inlet(m);
        else
            job.Mrel_inlet = M_inlet;
        end

        
        
        %% set polytropic efficiency
        job.np = np;
        
        %% change aeroparameters
        if strcmp(var,'load_coef')==1
            job.load_coef = sweep.load_coef(m);
        else
            job.load_coef = load_coef;
        end
        if strcmp(var,'dH')==1
            job.DeHaller = sweep.dH(m);
        else
            job.DeHaller = dH;
        end
        
        %% change streamtube contraction
        if strcmp(var,'Ax')==1
            job.f.Ax = sweep.Ax(m);
        else
            job.f.Ax = Ax;
        end
        
        %% calculate exit Mach number and flow angle
        [f]=mises_output_finput(job,mode);
        job.f = f;
        job.f.M = job.Mrel_inlet;
        
        
        %% set target exit flow angle and tot_cam initial value
        % set exit airflow angle
        alpha_tar = job.f.Alpha2;
        % first guess for total camber
        job.tot_cam = job.f.Alpha - job.f.Alpha2 - 3;
        job.tot_cam_temp = job.tot_cam;
        
        
        %% ADJUST FRACTION chord
        job.pitch_chord = 1; job.ss_points = 150; job.R_le = 1;
        [job]=ts_frac_chord_mises(job);
        
        %% Name new directory
        
        if mode  == 1
            ext = ['_psi0' num2str(100*job.load_coef) 'DH0'  num2str(100*job.DeHaller)];
        elseif mode  == 2
            ext = ['_psi0' num2str(100*job.load_coef) 'A' num2str(round(100*job.f.Ax))];
        elseif mode == 3
            ext = ['_DH0' num2str(100*job.DeHaller) 'A' num2str(round(100*job.f.Ax))];
        elseif mode == 4
            ext = ['_DH0' num2str(100*job.DeHaller) 'Axt' num2str(round(100*job.f.Ax))];
        end
        directory = ['/mnt/Disk1/dl467/Documents/Test_Cases/M' num2str(round(100*job.Mrel_inlet)) 'A' num2str(round(100*job.alpha_rel_inlet)/100) 'SC' num2str(round(100*s_c)) 'TC' num2str(round(100*t_c)) 'PC' num2str(round(100*job.percentage_cam)) ext '/MISES/']
        job.directory = directory;
        job.rjm_directory = directory;
        
        
        % conditions to start iteration
        if exist(directory,'dir') == 0 % check if diercotry exists
            start = 1;
        else
            cd(directory)
            [p,h] = mis_plot_section(directory,[],[0,0,1],0,job);
            
            if isempty(p) == 0 % already has converged solution
                start = 0;
            else
                if exist([directory 'job_init.mat']) ~= 0
                    load([directory 'job_init.mat']);
                    if job.initial_sol == 0
                        start = 0; % initial solution has run and not converged skip
                    else
                        load([directory 'job.mat']);
                        if isfield(job,'tot_cam_dummy') == 1
                            if length(job.tot_cam_dummy)~=1
                                start = 0;
                                disp('Has not been able to converge at optimised point')
                                disp(['Re-run at a 5% higher loss'])
                                job.tot_cam = interp1(job.loss_dummy./min(job.loss_dummy),job.tot_cam_dummy,1.05);
                                job.inlet_cam = interp1(job.loss_dummy./min(job.loss_dummy),job.inlet_cam_dummy,1.05);
                                if isnan(job.tot_cam) == 1
                                    disp(['Re-run at close to the highest loss covwerged'])
                                     job.tot_cam = interp1(job.loss_dummy./min(job.loss_dummy),job.tot_cam_dummy,0.99*max(job.loss_dummy./min(job.loss_dummy)));
                                     job.inlet_cam = interp1(job.loss_dummy./min(job.loss_dummy),job.inlet_cam_dummy,0.99*max(job.loss_dummy./min(job.loss_dummy)));
                                end
                                tot_cam = job.tot_cam
                                [p,h,job] =  mis_run_section_ss(job.rjm_directory,[],[0,0,1],0,1,0,job);
                                [p,h] = mis_plot_section(job.rjm_directory,h,color(i,:),0,job);
                                
                                if isempty(p) == 0
                                    save([job.rjm_directory 'job.mat'],'job')
                                else
                                    disp('Cound not run at slightly more loss')
                                end
                            else
                                start = 1;
                            end
                        else
                            start = 1;
                        end
                    end
                else
                    load([directory 'job.mat']);
                    if isfield(job,'tot_cam_dummy') == 1
                        if length(job.tot_cam_dummy)~=1
                            start = 0;
                            disp('Has not been able to converge at optimised point')
                            disp(['Re-run at a 5% higher loss'])
                            job.tot_cam = interp1(job.loss_dummy./min(job.loss_dummy),job.tot_cam_dummy,1.05);
                            job.inlet_cam = interp1(job.loss_dummy./min(job.loss_dummy),job.inlet_cam_dummy,1.05);
                            if isnan(job.tot_cam) == 1
                                disp(['Re-run at close to the highest loss covwerged'])
                                job.tot_cam = interp1(job.loss_dummy./min(job.loss_dummy),job.tot_cam_dummy,0.99*max(job.loss_dummy./min(job.loss_dummy)));
                                job.inlet_cam = interp1(job.loss_dummy./min(job.loss_dummy),job.inlet_cam_dummy,0.99*max(job.loss_dummy./min(job.loss_dummy)));
                            end
                            tot_cam = job.tot_cam
                            [p,h,job] =  mis_run_section_ss(job.rjm_directory,[],[0,0,1],0,1,0,job);
                            [p,h] = mis_plot_section(job.rjm_directory,h,color(i,:),0,job);
                            
                            if isempty(p) == 0
                                save([job.rjm_directory 'job.mat'],'job')
                            else
                                disp('Cound not run at slightly more loss')
                            end
                        else
                            start = 1;
                        end
                    else
                        start = 1;
                    end
                end
            end
        end
            
        if start == 1
            
            job.initial_sol = 1;
            if isfield(job,'loss_dummy') == 1
                job=rmfield(job,'loss_dummy');
            end
            if isfield(job,'tot_cam_dummy') == 1
                job=rmfield(job,'tot_cam_dummy');
            end
            if isfield(job,'inlet_cam_dummy') == 1
                job=rmfield(job,'inlet_cam_dummy');
            end
            
            
            %% get initial value of inlet blade metal angle based on unique incidence condition is no previous solution exists
%             if exist(directory,'dir') == 0 || (exist('inlet_cam_guess','var')==0 || isempty(inlet_cam_guess)==0)
            if exist('inlet_cam_guess','var')==0 
                [beta_i,M_s]=unique_incidence_detached_contr_MCA2(job,s_c*job.chord,job.Mrel_inlet,[],0);
                deltai = beta_i - job.inlet_cam;
                job.inlet_cam = job.alpha_rel_inlet - deltai;
                inlet_cam = job.inlet_cam;
                disp(['**** From unique incidence Delta = ' num2str(deltai) ' *****'])
            else
                job.inlet_cam = inlet_cam_guess; % use previous solutions or one set at the start
                disp('**** Inlet camber from previous solution *****')
            end
            
            %% run until you have correct guess for total camber sweep from -3 to +2 of total turning
            p=[];
            p.manual = 1;
            n_initial = 1;
            while p.manual == 1 && n_initial < 10
                [p,h,job] = mis_run_section_ss(directory,[],[0,0,1],0,1,1,job);
                if p.manual == 1
                    disp(['******Cannot run at this total camber ' num2str(job.tot_cam) ' ******'])
                end
                job.tot_cam = job.tot_cam + 0.50;
                n_initial = n_initial + 1;
            end
            if n_initial >= 10
                disp('***** Cannot run initial solution try again*****')
                job.initial_sol=0;
            end
            
            save([directory 'job_init.mat'],'job')
            save([directory 'job.mat'],'job')
            %%
            
            % iteration number
            ni = 1;
            n_HTE_max = 12;
            beta=1;
            beta_temp = beta;
            dtot_cam = 1.0;
            job.tot_cam_temp = job.tot_cam;
            job.inlet_cam_temp = job.inlet_cam;
            
            
            %% set default dalpha
            dalpha = 1.0;
            %%
            
            %
            if job.initial_sol==1
                
                [Polarx, Ises] = mis_read_polarx('mises',directory);
                if size(Polarx.sout,2) == 1
                    [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                else
                    [~,i_des] = min(abs(Polarx.binl-(Ises.binl)));
                    Polarx.sout = Polarx.sout(i_des);
                    Polarx.binl = Polarx.binl(i_des);
                end
                
                % Read in the grid coodinates
                if exist([directory 'idat.mises_01'],'file') ~= 0
                    Idat = mis_read_idat('mises_01',directory);
                else
                    Idat = mis_read_idat('mises',directory);
                end
                load([directory 'section.mat']);
                mt_stag = [Idat.x(Idat.ninl(2),end) Idat.y(Idat.ninl(2),end)];
                phi_stag = atan2(c.mt_le_cen(2) - mt_stag(2),c.mt_le_cen(1) - mt_stag(1)) * 360 / (2*pi);
                [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                p.manual = 0;
            
            
            
            
            while ni<n_HTE_max && abs(beta) > 0.3
                
                
                save([directory 'job_temp.mat'],'job');
                load([directory 'section.mat']);

                dalpha_sort(ni,i) = dalpha;
                inlet_cam(ni,i) = job.inlet_cam;
                
                if p.manual == 0
                    tot_cam(ni,i) = job.tot_cam_temp;
                    local_inc(ni,i) = phi_stag-c.chi_le;
                    H_TE(ni,i) = p.Hb_te;
                    loss(ni,i) = Polarx.omega;
                else
                    tot_cam(ni,i) = job.tot_cam_temp;
                    local_inc(ni,i) = 0;
                    H_TE(ni,i) = 0;
                    loss(ni,i) = 0;
                end
                
                
                % sort by increasing camber
                [tot_cam(:,i),i_sort]=sort(tot_cam(:,i),'descend')
                local_inc(:,i) = local_inc(i_sort,i);
                H_TE(:,i) = H_TE(i_sort,i);
                loss(:,i) = loss(i_sort,i)
                inlet_cam(:,i) = inlet_cam(i_sort,i)
                dalpha_sort(:,i) = dalpha_sort(i_sort,i);
                
                
                
                % In the case where beta is less or becomens negative (negative side of loop) than the initial value
                % restart from the minimum loss point
                if ni ~= 1 && beta~=beta_temp
                    
                    % Generate total cambers to interpolate
                    tot_cam_dummy = tot_cam(:,i);
                    tot_cam_dummy(tot_cam_dummy==0)=[];
                    [tot_cam_dummy,i_unique] = unique(tot_cam_dummy,'stable');
                    
                    tot_cam_interp = [linspace(tot_cam_dummy(1),tot_cam_dummy(end),100)];
                    tot_cam_interp = unique(tot_cam_interp,'stable');
                    
                    loss_dummy = loss(:,i);
                    loss_check = loss_dummy;
                    loss_dummy(loss_dummy==0)=NaN;
                    loss_dummy = loss_dummy(i_unique);
%                     % check if two points exist to interpolate otherwise
%                     % copy the one value
%                     loss_check(loss_check==0)=[];
%                     
%                     if length(loss_check) == 1
%                         loss_check = [loss_check; loss_check*1.5];
%                         % Spline all points
%                         loss_interp = interp1(tot_cam_dummy,loss_check,tot_cam_interp,'pchip');
%                     else
%                         % Spline all points
%                         loss_interp = interp1(tot_cam_dummy,loss_dummy,tot_cam_interp,'pchip');
%                     end
                    
                    % Find the point previous to the min
                    [~,i_min] = min(loss_dummy); loss_min = double(loss_dummy(i_min));
                    i_current = find(loss_dummy <= loss_min.*1.005,1,'last');
                    i_current = min(i_current);
                    
                    dalpha_dummy = dalpha_sort(:,i);
                    dalpha_dummy(dalpha_dummy==0)=NaN;
                    dalpha_dummy = dalpha_dummy(i_unique);
                    
                    inlet_cam_dummy = inlet_cam(:,i);
                    inlet_cam_dummy = inlet_cam_dummy(i_unique);
                    
                    job.tot_cam = tot_cam_dummy(i_current);
                    tot_cam_temp = tot_cam_dummy(i_current);
                    loss_temp = loss_dummy(i_current);
                    dalpha = dalpha_dummy(i_current);
                    job.inlet_cam = inlet_cam_dummy(i_current);
                    
                    beta_temp = beta;
                    
                elseif ni==1
                    loss_temp = loss(ni,i);
                    tot_cam_temp = tot_cam(ni,i);
                    tot_cam_dummy = tot_cam(:,i);
                    loss_dummy = loss(:,i);
                    dalpha_dummy = dalpha_sort(:,i);
                    inlet_cam_dummy = inlet_cam(:,i);
                end
                
                job.tot_cam_dummy = tot_cam_dummy;
                job.loss_dummy = loss_dummy;
                job.local_inc_dummy = dalpha_dummy;
                job.inlet_cam_dummy = inlet_cam_dummy;
                
                save([directory 'job.mat'],'job')
                
                % increase the total camber and run
                job.tot_cam_temp = job.tot_cam +  beta.*dalpha;
                
                
                %                 check if it has already run; continue to next point
                while job.tot_cam~=job.tot_cam_temp
                    for k = 1:length(tot_cam(:,i))
                        if tot_cam(k,i) == job.tot_cam_temp
                            job.tot_cam_temp = job.tot_cam_temp +  beta.*dalpha;
                            break
                        elseif k==length(tot_cam(:,i))
                            job.tot_cam = job.tot_cam_temp;
                        end
                    end
                end
                
                
                
                save([directory 'job.mat'],'job');
                [p,h,job] = mis_run_section_ss(directory,[],[0,0,1],0,1,1,job);
                
                %% check if tot_cam is not working change inlet blade metal angle (+/- 1 degree)
                %% if this doesnt work change total camber increment and start again from minimum loss.
                ni_bia_max = 5;
                ni_bia = 1;
                if p.manual == 1
                    job.inlet_cam = job.inlet_cam - 1;
                    while p.manual == 1 && ni_bia<=ni_bia_max
                        disp('****Cannot run at this total camber inlet blade metal angle changed****')
                        % 			job.tot_cam = job.tot_cam +  beta*dalpha;
                        job.inlet_cam = job.inlet_cam + 0.40;
                        [p,h,~] = mis_run_section_ss(directory,[],[0,0,1],0,1,1,job);
                        ni_bia = ni_bia+1;
                    end
                    if p.manual ==1
                        disp('***** Reduce increment in total camber by half and restart from minimum loss (Cannot converge at this level of total camber) *******')
                        beta = 0.5*beta;
                        if ni == 1 % to keep initial solution logged
                           ni = ni + 1;
                        end
                        % bring inlet cam back to initial solution value
                        job.inlet_cam = job.inlet_cam_temp;
                        continue
                    end
                end
                
                
                %%
                
                [Polarx, Ises] = mis_read_polarx('mises',directory);
                [p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
                p.manual = 0;
                bout = atand(Polarx.sout);
                Idat = mis_read_idat('mises',directory);
                load([directory 'section.mat']);
                
                mt_stag = [Idat.x(Idat.ninl(2),end) Idat.y(Idat.ninl(2),end)];
                phi_stag = atan2(c.mt_le_cen(2) - mt_stag(2),c.mt_le_cen(1) - mt_stag(1)) * 360 / (2*pi);
                
                ni = ni+1;
                tot_cam(ni,i) = job.tot_cam;
                local_inc(ni,i) = phi_stag-c.chi_le;
                H_TE(ni,i) = p.Hb_te;
                loss(ni,i) = Polarx.omega;
                inlet_cam(ni,i) = job.inlet_cam;
                
                
                % Record pressure rise value and update next point
                dloc_inc = local_inc(ni,i) - local_inc(ni-1); ni_current = length(local_inc(:,i));
                dloss = loss(ni,i)-loss_temp;
                loss_temp = loss(ni,i);
                dtot_cam = abs(tot_cam(ni,i)-tot_cam_temp);
                
                %% reduce change in camber if loss increases by more than 10% of minimum
                loss_min = min(loss(:,i));
                if loss(ni,1)/loss_min>1.15
                    %% Half the change in total camber
                    if beta > 0
                        disp('***** Loss 15% higher than minimum - start negative side *****')
                        beta = - beta;
                    elseif beta < 0
                        disp('***** Loss 15% higher than minimum on negative side*****')
                        break
                    end
                end
                
                
                %% ADJUST FRACTION chord
                [job]=ts_frac_chord_mises(job);
                
            end
            
            if ni>= n_HTE_max
                disp('***Cant fix H_TE - need to fix manually****');
            end
            
            % sort by increasing camber
            [tot_cam(:,i),i_sort]=sort(tot_cam(:,i),'descend')
            local_inc(:,i) = local_inc(i_sort,i);
            H_TE(:,i) = H_TE(i_sort,i);
            loss(:,i) = loss(i_sort,i)
            inlet_cam(:,i) = inlet_cam(i_sort,i)
            
            dalpha = beta.*(phi_stag-c.chi_le);
            if size(tot_cam,1) > size(dalpha_sort,1)
                dalpha_sort(ni,i) = dalpha;
            end
            dalpha_sort(:,i) = dalpha_sort(i_sort,i);
            
            save([directory 'job.mat'],'job');
            
            %% run minimum loss incidence
                
                % Generate flow coefficient vector to interpolate
                tot_cam_dummy = tot_cam(:,i);
                loss_dummy = loss(:,i);
                tot_cam_dummy(loss_dummy==0)=[];
                tot_cam_interp = tot_cam_dummy(1);
                [tot_cam_dummy,i_unique] = unique(tot_cam_dummy,'stable');
                
                tot_cam_interp = [linspace(tot_cam_interp,tot_cam_dummy(end),100)];
                tot_cam_interp = unique(tot_cam_interp,'stable');
                
                loss_dummy(loss_dummy==0)=[];
                loss_dummy = loss_dummy(i_unique);
                % Spline all points
                if length(tot_cam_interp) == 1
                    loss_interp = loss_dummy;
                else
                loss_interp = interp1(tot_cam_dummy,loss_dummy,tot_cam_interp,'pchip');
                end
                
                dalpha_dummy = dalpha_sort(:,i);
                dalpha_dummy(loss_dummy==0)=[];
                dalpha_dummy = dalpha_dummy(i_unique);
                
                inlet_cam_dummy = inlet_cam(:,i);
                inlet_cam_dummy(inlet_cam_dummy==0)=[];
                inlet_cam_dummy = inlet_cam_dummy(i_unique);
                
                % Find the point previous to the maximum
                [~,i_min] = min(loss_interp); loss_min = loss_interp(i_min);
                i_current = find(loss_dummy <= loss_min,1,'last');
                job.tot_cam = tot_cam_dummy(i_current);
                tot_cam_temp = tot_cam_dummy(i_current);
                loss_temp = loss_dummy(i_current);
                job.inlet_cam = inlet_cam_dummy(i_current);
                inlet_cam_temp = inlet_cam_dummy(i_current);
                
                
                job.tot_cam_dummy = tot_cam_dummy;
                job.loss_dummy = loss_dummy;
                job.local_inc_dummy = dalpha_dummy;
                job.inlet_cam_dummy = inlet_cam_dummy;
                
                save([directory 'job.mat'],'job')
                run_single = 0;
                [p,h,job] = mis_run_section_ss(directory,[],[0,0,1],0,1,run_single,job);
                
                % new guess for inlet cam
                inlet_cam_guess = inlet_cam_temp;
                
                save([directory 'job.mat'],'job');
                
                %% make plot
                
                figure(n); grid on; hold on;
                tot_cam_plot = tot_cam(:,i);
                local_inc_plot = local_inc(:,i);
                inlet_cam_plot = inlet_cam(:,i);
                local_inc_plot(local_inc_plot==0)=NaN;
                inlet_cam_plot(inlet_cam_plot==0)=NaN;
                loss_plot = loss(:,i);
                loss_plot(loss_plot==0)=NaN;
                [hAx,hLine1,hLine2]=plotyy(tot_cam_plot,loss_plot,tot_cam_plot,inlet_cam_plot);
                % 	ylabel('Local incidence \phi_{stag}-\chi_{le}')
                xlabel('Total camber \chi_{2}-\chi_{1}')
                ylabel(hAx(2),'Local incidence \phi_{stag}-\chi_{le}')
                % 	ylabel(hAx(2),'H_{TE}')
                ylabel(hAx(1),'Profile loss (Y_{p})')
                hAx(1).YColor=[0 0 1];
                hAx(2).YColor=[1,0,0];
                
                hLine1.Marker= 'x';
                hLine1.Color=color(m,:);
                hLine2.Marker= 'o';
                hLine2.Color=color(m,:);
                hLine1.LineWidth=1.1;
                hLine2.LineWidth=1.1;
                hLine2.LineStyle='--';
                % 	hAx(1).XLim = [9-2,9+2];
                % 	hAx(1).YLim = [0,0.1];
                % 	hAx(2).XLim = [9-2,9+2];
                % 	hAx(2).YLim = [0,2];
                
                
                % 	% run chic
                % 	if size(Polarx.sout,2) == 1
                % 		disp('***Running chic***')
                % 		[p,h,job] = mis_run_section(directory,[],[0,0,1],0,1,0,job);
                % 	end

            
            end
            
            
        end

    end
    
end

% end
% %%