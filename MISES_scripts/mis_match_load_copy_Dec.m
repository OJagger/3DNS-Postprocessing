% filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};

% filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade','M080SC100d3_no_hade','M080SC100d4_no_hade','M080SC100d6_no_hade','M075SC1007_no_hade','M075SC1008_no_hade','M090SC100g_no_hade2','M090SC100g_no_hade3','M080SC100l_no_hade','M080SC100m_no_hade','M080SC100n_no_hade','M080SC100p_no_hade'};

% filename = {'M090SC100a_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100i_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC100a_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100i_no_hade'};

filename = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M090SC100j_no_hade','M090SC100i_no_hade','M090SC100a_no_hade','M090SC100e_no_hade','M090SC100g_no_hade','M090SC100d_no_hade','M090SC100h_no_hade'};

filename = {'M090SC90j_no_hade_load_coef','M090SC90i_no_hade_load_coef','M090SC90a_no_hade_load_coef','M090SC90e_no_hade_load_coef','M090SC90g_no_hade_load_coef','M090SC90d_no_hade_load_coef','M090SC90h_no_hade_load_coef'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = filename;

% filename = {'M090SC100g_no_hade'};
% outnames = {'_SA_4_0'};
% rjm_directory = {'M090SC100g_no_hade'};

%% Mt=0.79; M=0.90; changing s/c;
% shorter list
% filename = {'RMCA0669a2','M09SC110','M09SC100c','M090SC090','M090SC080','M090SC070'};
% outnames = {'C5_SA_4','_SA_4_0','S4_SA_4','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'RMCA0669a2','M09SC110','M09SC100c','M090SC090','M090SC080','M090SC070'};

% filename = {'M090SC70_s_c_no_hade','M090SC80_s_c_no_hade','M090SC90_s_c_no_hade','M090SC100_s_c_no_hade','M090SC110_s_c_no_hade','M090SC120_s_c_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = {'M090SC70_s_c_no_hade','M090SC80_s_c_no_hade','M090SC90_s_c_no_hade','M090SC100_s_c_no_hade','M090SC110_s_c_no_hade','M090SC120_s_c_no_hade'};
% 
% %% M090SC100_thickness 2%
% filename = {'M090SC100j_no_hade_load_coef_2%','M090SC100i_no_hade_load_coef_2%','M090SC100a_no_hade_load_coef_2%','M090SC100e_no_hade_load_coef_2%','M090SC100g_no_hade_load_coef_2%','M090SC100d_no_hade_load_coef_2%','M090SC100h_no_hade_load_coef_2%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% rjm_directory = filename;
% 
% %% M090SC100 thickness 3%
% filename = {'M090SC100j_no_hade_load_coef_3%','M090SC100i_no_hade_load_coef_3%','M090SC100a_no_hade_load_coef_3%','M090SC100e_no_hade_load_coef_3%','M090SC100g_no_hade_load_coef_3%','M090SC100d_no_hade_load_coef_3%','M090SC100h_no_hade_load_coef_3%','M090SC100j_no_hade3_3%','M090SC100j_no_hade4_3%','M090SC100g_no_hade2_3%','M090SC100g_no_hade3_3%','M090SC100l_no_hade_3%','M090SC100m_no_hade_3%','M090SC100n_no_hade_3%','M090SC100p_no_hade_3%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% rjm_directory = filename;
% %%
% 
% %% M090SC100 A98%
% filename = {'M090SC100j_no_hade_load_coef_A98%','M090SC100i_no_hade_load_coef_A98%','M090SC100a_no_hade_load_coef_A98%','M090SC100e_no_hade_load_coef_A98%','M090SC100g_no_hade_load_coef_A98%','M090SC100d_no_hade_load_coef_A98%','M090SC100h_no_hade_load_coef_A98%','M090SC100j_no_hade3_A98%','M090SC100j_no_hade4_A98%','M090SC100g_no_hade2_A98%','M090SC100g_no_hade3_A98%','M090SC100l_no_hade_A98%','M090SC100m_no_hade_A98%','M090SC100n_no_hade_A98%','M090SC100p_no_hade_A98%'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% rjm_directory = filename;

filename = {'M090SC100d_no_hade'};
outnames = {'_SA_4_0'};
rjm_directory = filename;

%% M090SC080
% filename = {'M090SC80j_no_hade_load_coef','M090SC80i_no_hade_load_coef','M090SC80a_no_hade_load_coef','M090SC80e_no_hade_load_coef','M090SC80g_no_hade_load_coef','M090SC80d_no_hade_load_coef','M090SC80h_no_hade_load_coef','M090SC80j_no_hade3','M090SC80j_no_hade4','M090SC80g_no_hade2','M090SC80g_no_hade3','M090SC80l_no_hade'};
% outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
% outnames = [ outnames outnames ];
% % filename = [ filename {'M090SC80_70_no_hade','M090SC80_80_no_hade','M090SC80_90_no_hade','M090SC80_80_no_hade','M090SC80_110_no_hade'}];
% rjm_directory = filename;
%%
%% inlet Mach = 0.65;
filename = {'M065SC75j_no_hade','M065SC75i_no_hade','M065SC75a_no_hade','M065SC75e_no_hade','M065SC75g_no_hade'};
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};

%% inlet Mach = 1.10
filename = {'M110SC90j_no_hade','M110SC90i_no_hade','M110SC90l_no_hade','M110SC90m_no_hade','M110SC90n_no_hade'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110SC90j_no_hade','M110SC90i_no_hade','M110SC90l_no_hade','M110SC90m_no_hade','M110SC90n_no_hade'};

filename = {'M110bSC90j_no_hade','M110bSC90i_no_hade','M110bSC90l_no_hade','M110bSC90m_no_hade','M110bSC90n_no_hade'} ;
outnames = {'_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0','_SA_4_0'};
rjm_directory = {'M110bSC90j_no_hade','M110bSC90i_no_hade','M110bSC90l_no_hade','M110bSC90m_no_hade','M110bSC90n_no_hade'};

M = 1.1;
% Ax = 1;

s_c = 0.90;

%% ********Everything above shoud not be necessary (kept for history)********

%% figure details

color = [0,0,1;1,0,0;0,0.5,0;1,0,1;0.5,0,0.5;0.5,0.5,0.5;0,0,0;0.25,0.25,0.25;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0;0,0,0];
Linestyle = {'-','--',':','-.','-','-','-','-','-','-'};
n=figure;
grid on; hold on;

clear sweep chi_le_guess


%% set thickness details used as datum

% choose blade you want to derive thickness from
blade_name = 'XWB84k_IPC_R1';
load(['/mnt/Disk1/dl467/Documents/Blades_parameterised/' blade_name '.mat']);
% choose non-dimensional section you want to take thickness from
r_nondim = 0.85;
thick_names = {'rad_le','s_thick_max','rad_thick_max','wedge_te','thick_te','thick_max','tchord'};
cam_names = {'chi_le','chi_te','perc_cam','pitch_chord','knot_coef','qcam','dcam_le','dcam_te'};
cam_spline = 1;
c = bl_spline_eval(t,r_nondim,cam_spline);
for v = 1:length(thick_names)
        job.(thick_names{v}) = c.(thick_names{v});
end
for v = 1:length(cam_names)
        job.(cam_names{v}) = c.(cam_names{v});
end
% just used if you want to check datum blade section used for thickness
dev=[]; ote = 1; plot_stuff = 0;
[xrt,xrt_cam,xrt_ps,xrt_ss]=bl_construct_section(job,plot_stuff,ote,dev,cam_spline);

%% set datum radius and chord for mises (just used for reference)

job.r_mid = 0.2677;
job.r_le = 0.2677;
job.r_te = 0.2677;

job.tchord = 0.05;

%% set inlet variables for sweep
% sweep.perc_cam = [0.10 0.05 0.001 -0.05 -0.1 -0.15];
perc_cam = [0.001];

t_c = 3/100;
% sweep.t_c = [2 4 3 5 1]/100;
s_c = 0.80;
job.N = round((2*pi*job.r_mid./job.tchord)./s_c);
% sweep.s_c = [0.70 0.90 1.0 0.50 1.10];
sweep.s_c = [0.80 0.90 1.0];

alpha_rel_inlet = 60;
% sweep.alpha_rel_inlet = [45 50 55 60 65];
alpha_inlet = 0;
M_inlet = 0.95;

np = 0.95;
load_coef = 0.38;
% sweep.load_coef = [0.25 0.30 0.35 0.375 0.40 0.45];
% sweep.Ax = [1.05 0.925 1.025];
Ax = 1.0;
dH = 0.66;
mode = 2; % mode 1: constant psi & dh; mode 2: contant psi & Area ratio; mode 3: constnat dH and Area ratio ; mode 4: constant dH and throat area ratio

% extract variable that will be swept
var = fieldnames(sweep);
%%

for m = 1:length(sweep.(var{1}))
    
    % sweep through different perecentage cambers
%     perc_cam = [0.10 0.05 0.001 -0.05 -0.1 -0.15 -0.20 -0.25 -0.30 -0.40];
    perc_cam = [0.30 0.20 0.10 0.001 -0.1 -0.20 -0.30 ];
    for i = 1:length(perc_cam)
        
        job.percentage_cam = perc_cam(i);
        clear tot_cam local_inc H_TE loss dalpha_sort i_sort chi_le
        tot_cam = [];
        
        %% change geometric parameters i.e. thickness-to-chord and pitch-to-chord
        if strcmp(var,'s_c')==1
            s_c = sweep.s_c(m);
            job.N = round((2*pi*job.r_mid./job.chord)./s_c);
        end
        
        if strcmp(var,'t_c')==1
            job.t.thick_chord = sweep.t_c(m);
            t_c = sweep.t_c(m);
        else
            job.t.thick_chord = t_c;
        end
        
       
        
        %% change inlet flow angle (or U/cpTo1) and Mach number
        if strcmp(var,'alpha_rel_inlet')==1
            job.alpha_rel_inlet = sweep.alpha_rel_inlet(m);
            if exist('chi_le_guess','var')==0 || isempty(chi_le_guess)==0
                % initial guess
                job.chi_le = sweep.alpha_rel_inlet(m)-2.5;
            else % use previous solution as a better initial guess
                job.chi_le = chi_le_guess;
                disp(['Guess for inlet cam ' num2str(chi_le_guess)])
            end
        else
            job.alpha_rel_inlet = alpha_rel_inlet;
            
            if exist('chi_le_guess','var')==0 || isempty(chi_le_guess)==0
                % initial guess
                job.chi_le = alpha_rel_inlet-2.5;
            else % use previous solution as a better initial guess
                job.chi_le = chi_le_guess;
                disp(['Guess for inlet cam ' num2str(chi_le_guess)])
            end
        end
        
        if strcmp(var,'alpha_inlet')==1
            job.alpha_inlet = sweep.alpha_inlet(m);
        else
            job.alpha_inlet = alpha_inlet;
        end
        
        if strcmp(var,'M_inlet')==1
            job.Mrel_inlet = sweep.M_inlet(m);
        else
            job.Mrel_inlet = M_inlet;
        end

        
        
        %% set polytropic efficiency
        job.np = np;
        
        %% change aeroparameters
        if strcmp(var,'load_coef')==1
            job.load_coef = sweep.load_coef(m);
        else
            job.load_coef = load_coef;
        end
        if strcmp(var,'dH')==1
            job.DeHaller = sweep.dH(m);
        else
            job.DeHaller = dH;
        end
        
        %% change streamtube contraction
        if strcmp(var,'Ax')==1
            job.f.Ax = sweep.Ax(m);
        else
            job.f.Ax = Ax;
        end
        
        %% calculate exit Mach number and flow angle
        [f]=mises_output_finput(job,mode);
        job.f = f;
        job.f.M = job.Mrel_inlet;
   
        
        %% set target exit flow angle and tot_cam initial value
        % set exit airflow angle
        alpha_tar = job.f.Alpha2;
        % first guess for total camber
        job.tot_cam = job.f.Alpha - job.f.Alpha2 - 3;
        job.tot_cam_temp = job.tot_cam;
        
        
        %% ADJUST FRACTION chord
        job.pitch_chord = 1; job.ss_points = 150; job.R_le = 1;
        [job]=ts_frac_chord_mises(job);
        
        %% Name new directory
        
        if mode  == 1
            ext = ['_psi0' num2str(100*job.load_coef) 'DH0'  num2str(100*job.DeHaller)];
        elseif mode  == 2
            ext = ['_psi0' num2str(100*job.load_coef) 'A' num2str(round(100*job.f.Ax))];
        elseif mode == 3
            ext = ['_DH0' num2str(100*job.DeHaller) 'A' num2str(round(100*job.f.Ax))];
        elseif mode == 4
            ext = ['_DH0' num2str(100*job.DeHaller) 'Axt' num2str(round(100*job.f.Ax))];
        end
        directory = ['/mnt/Disk1/dl467/Documents/Test_Cases/M' num2str(round(100*job.Mrel_inlet)) 'A' num2str(round(100*job.alpha_rel_inlet)/100) 'SC' num2str(round(100*s_c)) 'TC' num2str(round(100*t_c)) 'PC' num2str(round(100*job.percentage_cam)) ext '/MISES/']
        job.directory = directory;
        job.rjm_directory = directory;
        directory = ['/home/dl467/Documents/Test_Cases/' filename{i} '/MISES/' ]
        cd(directory)
        mis_directory = strrep(directory,'TURBOSTREAM','MISES');
        load([mis_directory 'job.mat']);
        load([mis_directory 'section.mat']);
		
    [p,h,job] = mis_run_section(directory,[],[0,0,1],0,1,1,job);

	
    % iteration number
	ni = 1;
	n_HTE_max = 5;
	n_type_max = 6;
	beta=0.5;
	[Polarx, Ises] = mis_read_polarx('mises',directory);
	if size(Polarx.sout,2) == 1
	[p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
	else
		[~,i_des] = min(abs(Polarx.binl-(Ises.binl)));
		Polarx.sout = Polarx.sout(i_des);
	end
	tot_cam = job.chi_le - job.chi_te
	H_TE = 2;
	while abs(atand(Polarx.sout) - alpha_tar)>0.25 && ni<n_HTE_max
		save([directory 'job_temp.mat'],'job');
		delta_alpha = atand(Polarx.sout) - alpha_tar
		if H_TE<3
			if abs(beta*delta_alpha)<1
                job.chi_te_temp = job.chi_te - beta*delta_alpha;
			else
				job.chi_te_temp = job.chi_te - 1*sign(beta*delta_alpha);
			end
		else
			disp('*****TE boundary layer is separating*****')
			job.tot_cam_temp = job.tot_cam - 1;
			beta = beta*0.5;
			ni = ni + 1;
		end
		% make sure it is realistic
		if job.tot_cam_temp+job.chi_le<alpha_tar
			disp('******Removed unreasonable amount of camber****')
			job.tot_cam_temp=alpha_tar-job.chi_le+1.5;
		end
% 		job.percentage_cam_temp = job.percentage_cam * job.tot_cam/job.tot_cam_temp;
		job.chi_te = job.chi_te_temp;
% 		job.percentage_cam = job.percentage_cam_temp;
		tot_cam = job.tot_cam
		[p,h,job] = mis_run_section_ss(directory,[],[0,0,1],0,1,1,job);
		[Polarx, Ises] = mis_read_polarx('mises',directory);
		[p,h] = mis_plot_section(job.rjm_directory,[],[0,0,1],0,job);
		H_TE = p.Hb_te;
		bout = atand(Polarx.sout)
	end
	
	if ni>n_HTE_max
		disp('***Cant fix H_TE - need to fix manually****');
	end
	
% 	% run chic
% 	if size(Polarx.sout,2) == 1
% 		disp('***Running chic***')
% 		[p,h,job] = mis_run_section(directory,[],[0,0,1],0,1,0,job);
% 	end
     
	end
end